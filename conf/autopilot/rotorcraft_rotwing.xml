<!DOCTYPE autopilot SYSTEM "autopilot.dtd">

<autopilot name="Rotating Wing Autopilot">

  <state_machine name="ap" freq="PERIODIC_FREQUENCY" gcs_mode="true" settings_mode="true" settings_handler="autopilot_generated|SetModeHandler">

    <includes>
      <include name="generated/airframe.h"/>
      <include name="autopilot.h"/>
      <include name="autopilot_rc_helpers.h"/>
      <include name="navigation.h"/>
      <include name="guidance.h"/>
      <include name="stabilization.h"/>
      <include name="modules/radio_control/radio_control.h"/>
      <include name="modules/gps/gps.h"/>
      <include name="modules/actuators/actuators.h"/>
      <include name="modules/rotwing_drone/rotwing_state.h"/>
      <include name="modules/nav/ground_detect.h"/>

      <!-- Failsafe variables -->
      <define name="NO_GPS_LOST_WITH_DATALINK_TIME" value="20" cond="ifndef NO_GPS_LOST_WITH_DATALINK_TIME"/>
      <define name="NO_GPS_LOST_WITH_RC_VALID" value="FALSE" cond="ifndef NO_GPS_LOST_WITH_RC_VALID"/>
      <define name="RC_LOST_MODE" value="AP_MODE_NAV" cond="ifndef RC_LOST_MODE"/>
      <define name="FAILSAFE_DESCENT_SPEED" value="1.0" cond="ifndef FAILSAFE_DESCENT_SPEED"/>

      <!-- Modes -->
      <define  name="MODE_MANUAL"    value="AP_MODE_ATTITUDE_DIRECT"  cond="ifndef MODE_MANUAL"/>
      <define  name="MODE_AUTO2"     value="AP_MODE_NAV"              cond="ifndef MODE_AUTO2"/>
      <define  name="RCLost()"       value="(radio_control.status != RC_OK)"/> <!-- !=RC_OK might be a little strict -->
      <define  name="DLModeNav()"    value="(autopilot_mode_auto2 == AP_MODE_NAV)"/>
      <define  name="DLModeGuided()" value="(autopilot_mode_auto2 == AP_MODE_GUIDED)"/>
      <define  name="DLModeModule()" value="(MODE_AUTO1 == AP_MODE_MODULE)"/>
      <define  name="DLModeAZH()"    value="(MODE_AUTO1 == AP_MODE_ATTITUDE_Z_HOLD)"/>
    </includes>

    <settings>
      <dl_setting var="autopilot.kill_throttle" min="0" step="1" max="1" module="autopilot" values="Resurrect|Kill" handler="KillThrottle"/>
      <dl_setting var="autopilot_mode_auto2" min="2" step="1" max="3" module="autopilot" values="NAV|GUIDED"/>
    </settings>

    <control_block name="set_commands">
      <call fun="SetRotorcraftCommands(stabilization.cmd, autopilot_in_flight(), autopilot_get_motors_on())"/>
    </control_block>

    <control_block name="run_attitude_control">
      <call fun="guidance_v_run(autopilot_in_flight())" store="struct ThrustSetpoint thrust_sp"/>
      <call fun="stabilization_run(autopilot_in_flight(), &stabilization.rc_sp, &thrust_sp, stabilization.cmd)"/>
    </control_block>

    <control_block name="run_rate_control">
      <call fun="guidance_v_run(autopilot_in_flight())" store="struct ThrustSetpoint thrust_sp"/>
      <call fun="stabilization_run(autopilot_in_flight(), &stabilization.rc_sp, &thrust_sp, stabilization.cmd)"/>
    </control_block>

    <control_block name="run_guidance_control">
      <call fun="guidance_v_run(autopilot_in_flight())" store="struct ThrustSetpoint thrust_sp"/>
      <call fun="guidance_h_run(autopilot_in_flight())" store="struct StabilizationSetpoint stab_sp"/>
      <call fun="stabilization_run(autopilot_in_flight(), &stab_sp, &thrust_sp, stabilization.cmd)"/>
    </control_block>

    <control_block name="update_v_sp_gcs">
      <call fun="guidance_v_set_z(-nav.nav_altitude)"/>
      <call fun="guidance_h_set_pos(nav.carrot.y, nav.carrot.x)"/>
    </control_block>

    <exceptions>
      <exception cond="nav.too_far_from_home" deroute="HOME"/>
      <exception cond="kill_switch_is_on()" deroute="KILL"/>
    </exceptions>

    <!-- Kill throttle mode 0-->
    <mode name="KILL">
      <select cond="kill_switch_is_on()"/>
      <on_enter>
        <call fun="guidance_h_mode_changed(GUIDANCE_H_MODE_NONE)"/>
        <call fun="stabilization_mode_changed(STABILIZATION_MODE_NONE, 0)"/>
        <call fun="guidance_v_mode_changed(GUIDANCE_V_MODE_KILL)"/>
        <call fun="autopilot_set_in_flight(false)"/>
        <call fun="autopilot_set_motors_on(false)"/>
        <call fun="stabilization.cmd[COMMAND_THRUST] = 0"/>
      </on_enter>
      <control>
        <call fun="SetCommands(commands_failsafe)"/>
      </control>
    </mode>

    <!-- Failsafe mode 1-->
    <mode name="FAILSAFE" shortname="FAIL">
      <on_enter>
        <call fun="guidance_h_mode_changed(GUIDANCE_H_MODE_NONE)"/>
        <call fun="guidance_v_mode_changed(GUIDANCE_V_MODE_CLIMB)"/>
        <call fun="stabilization_mode_changed(STABILIZATION_MODE_ATTITUDE, STABILIZATION_ATT_SUBMODE_HEADING)"/>
        <call fun="guidance_v_set_vz(FAILSAFE_DESCENT_SPEED)"/>
        <call fun="NavStartDetectGround()"/>
      </on_enter>
      <control>
        <call fun="NavVerticalThrottleMode(MAX_PPRZ*(0.5))"/>
        <call fun="stabilization_get_failsafe_sp()" store="struct StabilizationSetpoint stab_failsafe"/>
        <call fun="guidance_v_run(autopilot_in_flight())" store="struct ThrustSetpoint thrust_sp"/>
        <call fun="stabilization_run(autopilot_in_flight(), &stab_failsafe, &thrust_sp, stabilization.cmd)"/>
        <call_block name="set_commands"/>
      </control>
      <exception cond="!GpsIsLost() && !(agl_dist_valid && agl_dist_value_filtered < 5.0)" deroute="$LAST_MODE"/>
      <exception cond="NavDetectGround()" deroute="Kill"/>
      <exception cond="!nav_is_in_flight()" deroute="Kill"/>
      <exception cond="ground_detect()" deroute="Kill"/>
    </mode>

    <!-- Home mode 2-->
    <mode name="HOME">
      <on_enter>
        <call fun="guidance_h_mode_changed(GUIDANCE_H_MODE_NAV)"/>
        <call fun="guidance_v_mode_changed(GUIDANCE_V_MODE_NAV)"/>
        <call fun="stabilization_mode_changed(STABILIZATION_MODE_ATTITUDE, STABILIZATION_ATT_SUBMODE_HEADING)"/>
      </on_enter>
      <control freq="NAVIGATION_FREQUENCY">
        <call fun="nav_home()"/>
      </control>
      <control>
        <call_block name="run_guidance_control"/>
        <call_block name="set_commands"/>
      </control>
      <exception cond="GpsIsLost() && autopilot_in_flight() && !NO_GPS_LOST_WITH_RC_VALID && (datalink_time > NO_GPS_LOST_WITH_DATALINK_TIME)" deroute="FAILSAFE"/>
    </mode>

    <!-- Rate mode 3-->
    <mode name="RATE_DIRECT" shortname="RATE">
      <!-- <select cond=""/> -->
      <on_enter>
        <call fun="guidance_h_mode_changed(GUIDANCE_H_MODE_NONE)"/>
        <call fun="guidance_v_mode_changed(GUIDANCE_V_MODE_RC_DIRECT)"/>
        <call fun="stabilization_mode_changed(STABILIZATION_MODE_RATE, 0)"/>
      </on_enter>
      <control freq="NAVIGATION_FREQUENCY">
        <call fun="nav_periodic_task()"/>
      </control>
      <control>
        <call_block name="run_rate_control"/>
        <call_block name="set_commands"/>
      </control>
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- Attitude mode 4-->
    <mode name="ATTITUDE_DIRECT" shortname="ATT_QUAD">
      <select cond="RCMode0()"/>
      <on_enter>
        <call fun="guidance_h_mode_changed(GUIDANCE_H_MODE_NONE)"/>
        <call fun="guidance_v_mode_changed(GUIDANCE_V_MODE_RC_DIRECT)"/>
        <call fun="stabilization_mode_changed(STABILIZATION_MODE_ATTITUDE, STABILIZATION_ATT_SUBMODE_HEADING)"/>
      </on_enter>
      <control freq="NAVIGATION_FREQUENCY">
        <call fun="nav_periodic_task()"/>
      </control>
      <control>
        <call_block name="run_attitude_control"/>
        <call_block name="set_commands"/>
      </control>
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- Rate climb rc mode 5-->
    <mode name="RATE_RC_CLIMB" shortname="RRCC">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- ATTITUDE_RC_CLIMB: 6 -->
    <mode name="ATTITUDE_RC_CLIMB" shortname="ATTITUDE_RC_CLIMB">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- ATTITUDE_CLIMB: 7 -->
    <mode name="ATTITUDE_CLIMB" shortname="ATTITUDE_CLIMB">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- RATE_Z_HOLD: 8 -->
    <mode name="RATE_Z_HOLD" shortname="RATE_Z_HOLD">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- ATTITUDE_Z_HOLD: 9 -->
    <mode name="ATTITUDE_Z_HOLD" shortname="A_ZH">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- HOVER_DIRECT: 10 -->
    <mode name="HOVER_DIRECT" shortname="HOVER_DIRECT">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- HOVER_CLIMB: 11 -->
    <mode name="HOVER_CLIMB" shortname="HOVER_CLIMB">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- HOVER_Z_HOLD: 12 -->
    <mode name="HOVER_Z_HOLD" shortname="HOVER_Z_HOLD">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- NAV: 13 -->
    <mode name="NAV">
      <select cond="RCMode2() && DLModeNav()" exception="HOME"/>
      <on_enter>
        <call fun="guidance_h_mode_changed(GUIDANCE_H_MODE_NAV)"/>
        <call fun="guidance_v_mode_changed(GUIDANCE_V_MODE_NAV)"/>
        <call fun="stabilization_mode_changed(STABILIZATION_MODE_ATTITUDE, STABILIZATION_ATT_SUBMODE_HEADING)"/>
      </on_enter>
      <control freq="NAVIGATION_FREQUENCY">
        <call fun="nav_periodic_task()"/>
        
      </control>
      <control>
        <call_block name="update_v_sp_gcs"/>
        <call_block name="run_guidance_control"/>
        <call_block name="set_commands"/>
      </control>
      <exception cond="GpsIsLost() && autopilot_in_flight() && !NO_GPS_LOST_WITH_RC_VALID && (datalink_time > NO_GPS_LOST_WITH_DATALINK_TIME)" deroute="FAILSAFE"/>
    </mode>

        <!-- RC_DIRECT: 14 -->
    <mode name="RC_DIRECT" shortname="RC_DIRECT">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- CARE_FREE_DIRECT: 15 -->
    <mode name="CARE_FREE_DIRECT" shortname="CARE_FREE_DIRECT">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- FORWARD: 16 -->
    <mode name="FORWARD" shortname="FW">
      <select cond="RCMode1()"/>
      <on_enter>
        <call fun="guidance_h_mode_changed(GUIDANCE_H_MODE_NONE)"/>
        <call fun="guidance_v_mode_changed(GUIDANCE_V_MODE_RC_DIRECT)"/>
        <call fun="stabilization_mode_changed(STABILIZATION_MODE_ATTITUDE, STABILIZATION_ATT_SUBMODE_FORWARD)"/>
      </on_enter>
      <control freq="NAVIGATION_FREQUENCY">
        <call fun="nav_periodic_task()"/>
      </control>
      <control>
        <call_block name="run_attitude_control"/>
        <call_block name="set_commands"/>
      </control>
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- MODULE: 17 -->
    <mode name="MODULE" shortname="MODULE">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- FLIP: 18 -->
    <mode name="FLIP" shortname="FLIP">
      <exception cond="RCLost()" deroute="NAV"/>
    </mode>

    <!-- GUIDED: 19 -->
    <mode name="GUIDED">
      <exception cond="GpsIsLost() && autopilot_in_flight() && !NO_GPS_LOST_WITH_RC_VALID && (datalink_time > NO_GPS_LOST_WITH_DATALINK_TIME)" deroute="FAILSAFE"/>
    </mode>  
  </state_machine>

</autopilot>
