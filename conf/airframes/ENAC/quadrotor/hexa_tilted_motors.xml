<!DOCTYPE airframe SYSTEM "../../airframe.dtd">

<airframe name="Hexa-Copter with tilted motors">

  <description>
    Fully actuated hexa copter with tilted motors

    * Autopilot:   Tawaki
    * Telemetry:   XBee
    * GPS:         datalink
    * RC:          SBUS
  </description>

  <firmware name="rotorcraft">
    <configure name="PERIODIC_FREQUENCY" value="500"/>
    <configure name="AHRS_PROPAGATE_FREQUENCY" value="$(PERIODIC_FREQUENCY)"/>

    <target name="ap" board="tawaki_2.0">
      <module name="radio_control" type="sbus"/>
      <define name="RADIO_KILL_SWITCH" value="RADIO_GAIN1"/>
    </target>

    <target name="nps" board="pc">
      <module name="fdm" type="jsbsim"/>
      <module name="radio_control" type="ppm"/>
      <define name="TAWAKIV2_IMU_ROT" value=""/>
      <define name="TAWAKIV2_MAG_ROT" value=""/>
    </target>

    <!--
    <module name="shell">
      <configure name="SHELL_PORT" value="uart3"/>
    </module>
    <module name="sys_mon"/>
    -->

    <module name="telemetry" type="xbee_api"/>
    <!--module name="flight_recorder"/-->

    <module name="actuators" type="dshot">
      <!--define name="DSHOT_SPEED" value="300"/-->
      <!-- <configure name="DSHOT_BIDIR" value="TRUE"/> -->
      <define name="DSHOT_TIM3_TELEMETRY_NUM" value="DSHOT_TLM_RX"/> <!--DSHTin-->
      <define name="DSHOT_TIM1_TELEMETRY_NUM" value="DSHOT_TLM_AUX_RX"/> <!-- AUXa2-->
    </module>

    <module name="board" type="tawaki_2.0">
      <define name="USE_DSHOT_TIM1" value="TRUE"/>
      <define name="DSHOT_TELEMETRY_TIMEOUT_MS" value="3"/>
      <define name="USE_PWM1" value="FALSE" />
      <define name="USE_PWM2" value="FALSE" />
      <define name="USE_PWM3" value="FALSE" />
      <define name="STM32_SERIAL_USE_UART4" value="TRUE" /><!--USE_UART4-->
      <define name="IMU_MPU_LOWPASS_FILTER" value="MPU60X0_DLPF_256HZ"/>
      <define name="IMU_MPU_ACCEL_LOWPASS_FILTER" value="MPU60X0_DLPF_ACC_218HZ"/>
      <define name="IMU_MPU_SMPLRT_DIV" value="0"/>
    </module>

    <module name="gps" type="optitrack"/>
    <module name="air_data"/>
    <module name="ins" type="ext_pose"/>

    <module name="stabilization" type="indi">
      <configure name="INDI_NUM_ACT" value="6"/>
      <configure name="INDI_OUTPUTS" value="6"/>
    </module>
    <module name="guidance" type="indi_fully_actuated"/>
    
  </firmware>

  <servos driver="DShot">
    <servo name="M1" no="2" min="0" neutral="100" max="2000"/>
    <servo name="M2" no="1" min="0" neutral="100" max="2000"/>
    <servo name="M3" no="3" min="0" neutral="100" max="2000"/>
    <servo name="M4" no="7" min="0" neutral="100" max="2000"/>
    <servo name="M5" no="6" min="0" neutral="100" max="2000"/>
    <servo name="M6" no="5" min="0" neutral="100" max="2000"/>
  </servos>

  <commands>
    <axis name="ROLL" failsafe_value="0"/>
    <axis name="PITCH" failsafe_value="0"/>
    <axis name="YAW" failsafe_value="0"/>
    <axis name="THRUST" failsafe_value="0"/>
  </commands>

  <command_laws>
    <set servo="M1" value="autopilot_get_motors_on() ? actuators_pprz[0] : -MAX_PPRZ"/>
    <set servo="M2" value="autopilot_get_motors_on() ? actuators_pprz[1] : -MAX_PPRZ"/>
    <set servo="M3" value="autopilot_get_motors_on() ? actuators_pprz[2] : -MAX_PPRZ"/>
    <set servo="M4" value="autopilot_get_motors_on() ? actuators_pprz[3] : -MAX_PPRZ"/>
    <set servo="M5" value="autopilot_get_motors_on() ? actuators_pprz[4] : -MAX_PPRZ"/>
    <set servo="M6" value="autopilot_get_motors_on() ? actuators_pprz[5] : -MAX_PPRZ"/>
  </command_laws>

  <section name="IMU" prefix="IMU_"> 
    <define name="ACCEL_CALIB" type="array">
      <field type="struct">
        <field name="abi_id" value="24"/>
        <field name="calibrated" type="struct">
          <field name="neutral" value="true"/>
          <field name="scale" value="true"/>
          <field name="rotation" value="true"/>
        </field>
        <field name="neutral" value="-10,-47,-130" type="int[]"/>
        <field name="scale" value="{{36821,8142,5741},{60003,13319,9358}}"/>
        <field value="TAWAKIV2_IMU_ROT"/>
      </field>
    </define>
    <define name="GYRO_CALIB" type="array">
      <field type="struct">
        <field name="abi_id" value="24"/>
        <field name="calibrated" type="struct">
          <field name="neutral" value="false"/>
          <field name="scale" value="false"/>
          <field name="rotation" value="true"/>
        </field>
        <field value="TAWAKIV2_IMU_ROT"/>
      </field>
    </define>
    <define name="MAG_CALIB" type="array">
      <field type="struct">
        <field name="abi_id" value="3"/>
        <field name="calibrated" type="struct">
          <field name="neutral" value="true"/>
          <field name="scale" value="true"/>
          <field name="rotation" value="true"/>
        </field>
        <field name="neutral" value="791,-190,2545" type="int[]"/>
        <field name="scale" value="{{26437,35997,25098},{35181,44272,29767}}"/>
        <field value="TAWAKIV2_MAG_ROT"/>
      </field>
    </define>
  
    <define name="BODY_TO_IMU_PHI" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_THETA" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_PSI" value="0." unit="deg"/>
  </section> 

  <include href="conf/mag/toulouse_muret.xml"/>

  <section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
    <!-- setpoint limits for attitude stabilization rc flight -->
    <define name="SP_MAX_PHI" value="45" unit="deg"/>
    <define name="SP_MAX_THETA" value="45" unit="deg"/>
    <define name="SP_MAX_R" value="60" unit="deg/s"/>
    <define name="DEADBAND_A" value="0"/>
    <define name="DEADBAND_E" value="0"/>
    <define name="DEADBAND_R" value="50"/>
  </section>

  <section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">
    <!-- reference acceleration for attitude control -->
    <define name="REF_ERR_P" value="120"/>
    <define name="REF_ERR_Q" value="130"/>
    <define name="REF_ERR_R" value="120"/>
    <define name="REF_RATE_P" value="15.0"/>
    <define name="REF_RATE_Q" value="15.0"/>
    <define name="REF_RATE_R" value="10.0"/>

    <define name="MAX_R" value="120" unit="deg/s"/>

    <!-- second order filter parameters -->
    <define name="FILT_CUTOFF" value="4.0"/>
    <define name="FILT_CUTOFF_R" value="4.0"/>

    <!-- Adaptive Learning Rate -->
    <define name="USE_ADAPTIVE" value="FALSE"/>
    <define name="ADAPTIVE_MU" value="0.0001"/>

    <!-- control effectiveness Hexa Form-->
    <define name="G1" type="matrix">
      <!--field name="ROLL"     value="{ -20.0,  -35,  -20,  20.0,  35,   20 }"/>
      <field name="PITCH"    value="{  35,   0,   -35,   -35,    0,  35 }"/>
      <field name="YAW"      value="{  2,   -2,    2,   -2,    2,   -2 }"/>
      <field name="THRUST_X" value="{ -0.1, 0.2, -0.1, -0.1, 0.2, -0.1}"/>
      <field name="THRUST_Y" value="{ 0.2,  0,   -0.2,  0.2,  0 , -0.2 }"/>
      <field name="THRUST_Z" value="{ -0.35, -0.35, -0.35, -0.35, -0.35, -0.35}"/-->
      <field name="NPS_ROLL"   value="{  -19.0,  -37,  -19,  19.0,  37,   19 }"/>
      <field name="NPS_PITCH"  value="{  30,   0,   -30,   -30,    0,  30 }"/>
      <field name="NPS_YAW"    value="{   2,   -2,    2,   -2,    2,   -2 }"/>
      <field name="NPS_THRUST_X" value="{-0.05, 0.1, -0.05, -0.05, 0.1, -0.05}"/>
      <field name="NPS_THRUST_Y" value="{0.1,  0,   -0.1,  0.1,  0 , -0.1 }"/>
      <field name="NPS_THRUST_Z" value="{-0.4, -0.4, -0.4, -0.4, -0.4, -0.4}"/>
    </define>
    <define name="G2"        value="{0.0, -0, 0, -0.0 , 0.0 , -0.0}"/>

    <!-- first order actuator dynamics -->
    <!--define name="ACT_FREQ" value="{25.6, 25.6, 25.6, 25.6, 25.6, 25.6}"/-->
    <define name="ACT_FREQ" value="{10.10, 10.10, 10.10, 10.10, 10.10, 10.10}"/>

    <define name="ESTIMATION_FILT_CUTOFF" value="4.0"/>

    <!-- Priority for each axis -->
    <!-- ROLL,PITCH,YAW,Tx,Ty,Tz -->
    <define name="WLS_PRIORITIES" value="{10000, 10000, 10, 100, 100, 1000}"/>
    <define name="RPM_FEEDBACK" value="FALSE"/>

    <!-- Thrusters contribute to global force in all directions -->
    <define name="ACT_THRUST_MAT" type="matrix">
      <field name="THRUST_X" value="{1,1,1,1,1,1}"/>
      <field name="THRUST_Y" value="{1,1,1,1,1,1}"/>
      <field name="THRUST_Z" value="{1,1,1,1,1,1}"/>
    </define>
  </section>

  <section name="WLS" prefix="WLS_">
    <define name="N_U_MAX" value="6"/>
    <define name="N_V_MAX" value="6"/>
  </section>

  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="REF_MIN_ZDD" value="-0.4*9.81"/>
    <define name="REF_MAX_ZDD" value=" 0.4*9.81"/>
    <define name="REF_MIN_ZD" value="-1.5"/>
    <define name="REF_MAX_ZD" value=" 1."/>
  </section>

  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <define name="MAX_BANK" value="20" unit="deg"/>
  </section>

  <section name="GUIDANCE_INDI" prefix="GUIDANCE_INDI_">
    <define name="NU" value="6"/> <!-- 6 for force alloc, 3 for quadrotor -->
    <define name="MASS" value="0.8"/>
    <define name="POS_GAIN" value="0.1"/>
    <define name="SPEED_GAIN" value="0.4"/>
  </section>

  <section name="NAV">
    <define name="ARRIVED_AT_WAYPOINT" value="0.25"/>
    <define name="NAV_DESCEND_VSPEED" value="-0.5"/>
    <define name="NAV_CLIMB_VSPEED" value="0.5"/>
    <define name="NAV_RADIUS" value="1.5"/>
  </section>

  <section name="BAT">
    <define name="CRITIC_BAT_LEVEL" value="9.3" unit="V"/>
  </section>

  <section name="AUTOPILOT">
    <define name="MODE_STARTUP" value="AP_MODE_NAV"/>
    <define name="MODE_MANUAL" value="AP_MODE_ATTITUDE_DIRECT"/>
    <define name="MODE_AUTO1" value="AP_MODE_ATTITUDE_Z_HOLD"/>
    <define name="MODE_AUTO2" value="AP_MODE_NAV"/>
  </section>

  <section name="GCS">
    <define name="ALT_SHIFT_PLUS_PLUS" value="5"/>
    <define name="ALT_SHIFT_PLUS" value="1"/>
    <define name="ALT_SHIFT_MINUS" value="-1"/>
  </section>

  <section name="SIMULATOR" prefix="NPS_">
    <define name="ACTUATOR_NAMES" value="motor1,motor2,motor3,motor4,motor5,motor6" type="string[]"/>
    <define name="JSBSIM_MODEL" value="FAHEX" type="string"/>
    <define name="COMMANDS_NB" value="6"/>
    <define name="NO_MOTOR_MIXING" value="TRUE"/>
    <!--<define name="ACTUATORS_ORDER" value="{0,1,2,3,4,5}"/>
    <define name="PYBULLET_MODULE" value="simple_Hexa_sim" type="string"/>
    <define name="PYBULLET_URDF" value="hexa_6DOF_simple.urdf" type="string"/> -->
  </section>

</airframe>

