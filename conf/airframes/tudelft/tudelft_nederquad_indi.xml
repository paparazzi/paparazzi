<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<!-- this is a quadrotor frame equiped with
* Autopilot:   Pixhawk 4
* IMU:         L3GD20 +  LSM303D + MPU6000 + external HMC58XX
* Actuators:   PWM motor controllers
* GPS:         Ublox                  http://wiki.paparazziuav.org/wiki/Subsystem/gps
* RC:          SBUS
-->
<airframe name="tudelft_quado">
  <description>Quadooooo</description>
  <firmware name="rotorcraft">
    <target name="ap" board="px4fmu_5.0_chibios" />
      <define name="BAT_CHECKER_DELAY" value="80" />
    <!-- <define name="RADIO_MODE_2x3" value="true"/> -->
    <!-- amount of time it take for the bat to check -->
    <!-- to avoid bat low spike detection when strong pullup withch draws short sudden power-->
      <define name="CATASTROPHIC_BATTERY_KILL_DELAY" value="80" />
    <!-- in seconds-->
       <!-- Note that PERIODIC_FREQUENCY should be least equal or greater than AHRS_PROPAGATE_FREQUENCY -->
     <configure name="PERIODIC_FREQUENCY" value="500"/> <!--  unit="Hz" -->

   <!--   <define name="MPU6000_GYRO_RANGE" value="MPU60X0_GYRO_RANGE_2000"/>
      <define name="MPU6000_ACCEL_RANGE" value="MPU60X0_ACCEL_RANGE_16G"/>
      <define name="IMU_MPU_ACCEL_LOWPASS_FILTER" value="MPU60X0_DLPF_256HZ"/>
      <define name="IMU_MPU_LOWPASS_FILTER" value="MPU60X0_DLPF_256HZ"/>
      <define name="IMU_MPU_SMPLRT_DIV" value="3"/>-->

     <!-- <configure name="AHRS_PROPAGATE_FREQUENCY" value="2000"/>--><!--  unit="Hz" -->
    <!--  <configure name="AHRS_CORRECT_FREQUENCY" value="2000"/> --><!--  unit="Hz" -->
    <!--  <configure name="AHRS_MAG_CORRECT_FREQUENCY" value="50"/>--><!-- best value unit="Hz" for ACTIVE magneto -->

    <!--  <configure name="NAVIGATION_FREQUENCY" value="16"/>--> <!--  unit="Hz" -->
    <!--  <configure name="CONTROL_FREQUENCY" value="120"/>--> <!--  unit="Hz" -->
      <!--<configure name="TELEMETRY_FREQUENCY" value="60"/--> <!--  unit="Hz" -->
    <!--  <configure name="MODULES_FREQUENCY" value="2000"/>--> <!--  unit="Hz" -->

    <module name="telemetry" type="transparent">
       <!--<configure name="MODEM_PORT" value="UART3"/>--><!--  Telem2 on pixhawk4 -->
       <!--<configure name="MODEM_PORT" value="UART7"/>--><!--  DebugUart on pixhawk4 -->
       <configure name="MODEM_BAUD" value="B115200"/>
    </module>
    
    <module name="baro_ms5611_spi" >
      <configure name="MS5611_SPI_DEV" value="spi1"/>
      <configure name="MS5611_SLAVE_IDX" value="SPI_SLAVE3"/>
      <!--<define name="SENSOR_SYNC_SEND"/>-->
    </module>

      <!-- Logger -->
      <module name="tlsf"/>
      <module name="pprzlog"/>
      <module name="logger" type="sd_chibios"/>
      <module name="flight_recorder"/>

    <module name="imu" type="mpu6000">
        <define name="IMU_MPU_CHAN_X" value="1"/>
        <define name="IMU_MPU_CHAN_Y" value="2"/>
        <define name="IMU_MPU_CHAN_Z" value="0"/>
        <define name="IMU_MPU_X_SIGN" value="+1"/>
        <define name="IMU_MPU_Y_SIGN" value="-1"/>
        <define name="IMU_MPU_Z_SIGN" value="-1"/>
     </module>
     
    <module name="gps" type="ublox" >
      <configure name="GPS_BAUD" value="B57600"/>
    </module>
    <module name="gps" type="ubx_ucenter" />
    <module name="stabilization" type="indi_simple" />
    <!--<module name="stabilization" type="rate_indi" />-->
    <!--<module name="ahrs" type="float_cmpl_quat">
    <configure name="USE_MAGNETOMETER" value="false"/>
    <define name="AHRS_USE_GPS_HEADING" value="false"/>
    </module>-->

    <module name="ins" type="ekf2">
      <!--<define name="INS_EKF2_MAG_ID" value="MAG_HMC58XX_SENDER_ID"/>-->
    </module>

    <module name="current_sensor">
     <configure name="ADC_CURRENT_SENSOR" value="ADC_2" />
    </module>

      <!-- SBUS out is AETR by default, our transmitter sends TAER as per standard so correct in radio file -->
    <module name="radio_control" type="sbus"> <!-- The output type of RX, over the air it can can be all kinds e.g. DSMX, FRSky-->
        <!--<configure name="SBUS_PORT" value="UART5"/>--> <!-- Default used port is UART2  on FMU4 -->
        <!-- Mode set one a three way switch -->
        <!--  Per default already GEAR if not defined  <define name="RADIO_MODE" value="RADIO_GEAR"/> --><!-- yes, already done by default if not redefined to something else-->
      <define name="RADIO_KILL_SWITCH" value="RADIO_AUX1"/>
      <configure name="SBUS_PORT" value="UART3"/>
    </module>

    <module name="geo_mag" />
    <module name="air_data" />
    <module name="send_imu_mag_current" />

    <!-- external mag for better heading estimate
    uses the magnetometor that is available on the GPS board
    Thi one is temperature compensated and furtherest away from all other devices
    so less influens (still to measure raw mag values to check this though )
    In case we where sloppy builing in the GPS+mag combo, ..we always are ;)
    we nead to compensate this a bit e.g. the pitch
    our luck at least the tree axis are aligned already in hardware :) -->
 
     <module name="mag" type="hmc58xx">
      <!--define name="HMC58XX_MAG_TO_IMU_PHI" value="0." unit="deg"/>
      <define name="HMC58XX_MAG_TO_IMU_THETA" value="0." unit="deg"/>
      <define name="HMC58XX_MAG_TO_IMU_PSI" value="180." unit="deg"/-->
      <!--<define name="HMC58XX_STARTUP_DELAY" value="1.4"/>--><!-- If you mag somehow does not work, Enable this line, and maybe even change it to a higher value if it still does not work e.g. 1.9 -->
      <configure name="MAG_HMC58XX_I2C_DEV" value="i2c1"/>
      <!--<define name="MODULE_HMC58XX_SYNC_SEND" value="TRUE"/>--><!-- temporary for debugging external magneto and setup orientation sign and Body to Magneto angles-->
      <define name="MODULE_HMC58XX_UPDATE_AHRS" value="TRUE"/> <!-- When all calib and works to TRUE -->

      <define name="HMC58XX_CHAN_X" value="1"/>
      <define name="HMC58XX_CHAN_Y" value="0"/>
      <define name="HMC58XX_CHAN_Z" value="2"/>
      <define name="HMC58XX_CHAN_X_SIGN" value="-"/>
      <define name="HMC58XX_CHAN_Y_SIGN" value="+"/>
      <define name="HMC58XX_CHAN_Z_SIGN" value="+"/>
    </module> 


    <module name="motor_mixing"/>

    <module name="actuators" type="pwm">
      <define name="SERVO_HZ" value="400" />
    </module>

    <module name="step_stab_att_quat_int"/>

    <!-- To get the signs (and channels) right, show a realtime plot scaled IMU_MAG mx, my, mz then:

    - [x] When you align your IMU with the direction of north, you should see x>0, y=~0, z>0.

    - [x] When pitching the IMU down, the magnetic vector is aligning with x,
          so x should increase and z should decrease to zero.

    - [x] If yawing your IMU to the left, the magnetic vector is aligning with y,
          so y should be positive and increase, x should decrease to zero and z stay positive.
-->
  </firmware>

  <section name="MISC">
    <!--<define name="MilliAmpereOfAdc(adc)" value="((float)adc) * (3.3f / 4096.0f) * (90.0f / 5.0f)" />-->
    <!-- 100Amp = 2Volt -> 2482,42 tick/100Amp"(0.0402832*adc)" -->
    <define name="BAT_CHECKER_DELAY" value="80" />
  </section>

  <section name="IMU" prefix="IMU_">
    <!-- replace this with your own calibration -->
    <define name="ACCEL_X_NEUTRAL" value="-165"/>
    <define name="ACCEL_Y_NEUTRAL" value="10"/>
    <define name="ACCEL_Z_NEUTRAL" value="-33"/>
    <define name="ACCEL_X_SENS" value="4.7821440532144" integer="16"/>
    <define name="ACCEL_Y_SENS" value="4.836131753637321" integer="16"/>
    <define name="ACCEL_Z_SENS" value="4.896888362921523" integer="16"/>

    <define name="BODY_TO_IMU_PHI"   value="1.2" unit="deg"/>
    <define name="BODY_TO_IMU_THETA" value="57." unit="deg"/>
    <define name="BODY_TO_IMU_PSI"   value="0." unit="deg"/>

    <!--Calibrated outside, based on sw/tools/calibration/calibrate.py -s MAG var/logs/16_12_05__16_32_21.data -vp -->
    <define name="MAG_X_NEUTRAL" value="105"/>
    <define name="MAG_Y_NEUTRAL" value="10"/>
    <define name="MAG_Z_NEUTRAL" value="-23"/>
    <define name="MAG_X_SENS" value="4.01453293111" integer="16"/>
    <define name="MAG_Y_SENS" value="3.96379405627" integer="16"/>
    <define name="MAG_Z_SENS" value="3.92499630895" integer="16"/> 

    <!--<define name="MAG_X_NEUTRAL" value="-168"/>
    <define name="MAG_Y_NEUTRAL" value="25"/>
    <define name="MAG_Z_NEUTRAL" value="-20"/>
    <define name="MAG_X_SENS" value="4.391900221475915" integer="16"/>
    <define name="MAG_Y_SENS" value="3.675142624727608" integer="16"/>
    <define name="MAG_Z_SENS" value="4.487949192790667" integer="16"/>-->

  </section>
  <commands>
    <axis name="PITCH" failsafe_value="0" />
    <axis name="ROLL" failsafe_value="0" />
    <axis name="YAW" failsafe_value="0" />
    <axis name="THRUST" failsafe_value="0" />
    <axis name="RELEASE" failsafe_value="-9600" />
  </commands>
  <rc_commands>
    <set command="THRUST" value="@THROTTLE" />
    <set command="ROLL" value="@ROLL" />
    <set command="PITCH" value="@PITCH" />
    <set command="YAW" value="@YAW" />
    <set command="RELEASE" value="@AUX2" />
  </rc_commands>

  <servos driver="Default">
    <servo name="TOP_LEFT" no="2" min="1000" neutral="1100" max="2000" /><!-- OK -->
    <servo name="TOP_RIGHT" no="3" min="1000" neutral="1100" max="2000" /><!-- OK -->
    <servo name="BOTTOM_RIGHT" no="1" min="1000" neutral="1100" max="2000" /><!-- OK -->
    <servo name="BOTTOM_LEFT" no="0" min="1000" neutral="1100" max="2000" /><!-- OK -->
    <servo name="RELEASE_SERVO" no="4" min="1100" neutral="1400" max="2000"/><!-- min:2000,neutral:1600,max:1200 for release -->
  </servos>
  
  <section name="MIXING" prefix="MOTOR_MIXING_">
    <define name="TRIM_ROLL" value="0" />
    <define name="TRIM_PITCH" value="0" />
    <define name="TRIM_YAW" value="0" />
    <define name="REVERSE" value="TRUE" />
    <define name="TYPE" value="QUAD_X" />
  </section>

  <command_laws>
    <call fun="motor_mixing_run(autopilot_get_motors_on(),FALSE,values)" />
    <set servo="TOP_LEFT" value="motor_mixing.commands[MOTOR_FRONT_LEFT]" />
    <set servo="TOP_RIGHT" value="motor_mixing.commands[MOTOR_FRONT_RIGHT]" />
    <set servo="BOTTOM_RIGHT" value="motor_mixing.commands[MOTOR_BACK_RIGHT]" />
    <set servo="BOTTOM_LEFT" value="motor_mixing.commands[MOTOR_BACK_LEFT]" />
    <set servo="RELEASE_SERVO" value="@RELEASE" />
  </command_laws>

  <section name="AIR_DATA" prefix="AIR_DATA_">
    <define name="CALC_AIRSPEED" value="FALSE" />
    <define name="CALC_TAS_FACTOR" value="FALSE" />
    <define name="CALC_AMSL_BARO" value="TRUE" />
  </section>
  <!-- local magnetic field -->
  <!-- http://wiki.paparazziuav.org/wiki/Subsystem/ahrs#Local_Magnetic_Field -->
  <section name="AHRS" prefix="AHRS_">
    <!-- values used if no GPS fix, on 3D fix is update by geo_mag module -->
    <!-- Delft -->
    <define name="H_X" value="0.3892503" />
    <define name="H_Y" value="0.0017972" />
    <define name="H_Z" value="0.9211303" />
    <!-- For vibrating airfames -->
    <!--<define name="GRAVITY_HEURISTIC_FACTOR" value="0"/>-->
  </section>

  <section name="INS" prefix="INS_">
    <define name="SONAR_MAX_RANGE" value="2.2" />
    <define name="SONAR_UPDATE_ON_AGL" value="TRUE" />
  </section>

  <!-- setpoint limits for attitude stabilization rc flight -->
  <!-- <section name="RC_SETPOINT" prefix="STABILIZATION_ATTITUDE_">   
    <define name="SP_MAX_PHI" value="45" unit="deg" />
    <define name="SP_MAX_THETA" value="45" unit="deg" />
    <define name="SP_MAX_R" value="300" unit="deg/s" />
    <define name="DEADBAND_A" value="0" />
    <define name="DEADBAND_E" value="0" />
    <define name="DEADBAND_R" value="50" />
  </section> -->
<!-- attitude reference generation model -->
  <!-- <section name="ATTITUDE_REFERENCE" prefix="STABILIZATION_ATTITUDE_">
    <define name="REF_OMEGA_P" value="450" unit="deg/s" />
    <define name="REF_ZETA_P" value="0.9" />
    <define name="REF_MAX_P" value="600." unit="deg/s" />
    <define name="REF_MAX_PDOT" value="RadOfDeg(8000.)" />
    <define name="REF_OMEGA_Q" value="450" unit="deg/s" />
    <define name="REF_ZETA_Q" value="0.9" />
    <define name="REF_MAX_Q" value="600." unit="deg/s" />
    <define name="REF_MAX_QDOT" value="RadOfDeg(8000.)" />
    <define name="REF_OMEGA_R" value="450" unit="deg/s" />
    <define name="REF_ZETA_R" value="0.9" />
    <define name="REF_MAX_R" value="600." unit="deg/s" />
    <define name="REF_MAX_RDOT" value="RadOfDeg(8000.)" />
  </section> -->

  <section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">
    <!-- control effectiveness -->
    <define name="G1_P" value="0.01965369" />
    <define name="G1_Q" value="0.018093345" />
    <define name="G1_R" value="0.002" />
    <define name="G2_R" value="0.0000000" />
    <!-- For the bebop2 we need to filter the roll rate due to the dampers -->
    <define name="FILTER_ROLL_RATE" value="TRUE" />
    <define name="FILTER_PITCH_RATE" value="TRUE" />
    <define name="FILTER_YAW_RATE" value="TRUE" />
    <!-- reference acceleration for attitude control -->
    <define name="REF_ERR_P" value="150" />
    <define name="REF_ERR_Q" value="150" />
    <define name="REF_ERR_R" value="49" />
    <define name="REF_RATE_P" value="22.5" />
    <define name="REF_RATE_Q" value="22.5" />
    <define name="REF_RATE_R" value="6" />
    <!-- second order filter parameters -->
    <define name="FILT_CUTOFF" value="1.5"/>
    <define name="FILT_CUTOFF_R" value="0.5"/>
    <!-- first order actuator dynamics -->
    <define name="ACT_DYN_P" value="0.0354" />
    <define name="ACT_DYN_Q" value="0.0354" />
    <define name="ACT_DYN_R" value="0.0354" />
    <!-- Adaptive Learning Rate -->
    <define name="USE_ADAPTIVE" value="FALSE" />
    <define name="ADAPTIVE_MU" value="0.0001" />

    <!-- max yaw rate (conservative) -->
    <define name="MAX_R" value="360" unit="deg/s"/> <!--Does not seem to be applied-->
  </section>

  <section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
    <!-- setpoints -->
    <define name="SP_MAX_PHI" value="25" unit="deg"/>
    <define name="SP_MAX_THETA" value="25" unit="deg"/>
    <define name="SP_MAX_R" value="180" unit="deg/s"/>
    <define name="DEADBAND_A" value="2"/>
    <define name="DEADBAND_E" value="2"/>
    <define name="DEADBAND_R" value="50"/>

    <!-- reference -->
    <define name="REF_OMEGA_P" value="450" unit="deg/s"/>
    <define name="REF_ZETA_P" value="0.9"/>
    <define name="REF_MAX_P" value="600." unit="deg/s"/>
    <define name="REF_MAX_PDOT" value="RadOfDeg(8000.)"/>

    <define name="REF_OMEGA_Q" value="450" unit="deg/s"/>
    <define name="REF_ZETA_Q" value="0.9"/>
    <define name="REF_MAX_Q" value="600." unit="deg/s"/>
    <define name="REF_MAX_QDOT" value="RadOfDeg(8000.)"/>

    <define name="REF_OMEGA_R" value="200" unit="deg/s"/>
    <define name="REF_ZETA_R" value="0.9"/>
    <define name="REF_MAX_R" value="300." unit="deg/s"/>
    <define name="REF_MAX_RDOT" value="RadOfDeg(4000.)"/>

    <!-- feedback -->
    <define name="PHI_PGAIN" value="600"/>
    <define name="PHI_DGAIN" value="200"/>
    <define name="PHI_IGAIN" value="40"/>

    <define name="THETA_PGAIN" value="750"/>
    <define name="THETA_DGAIN" value="250"/>
    <define name="THETA_IGAIN" value="40"/>

    <define name="PSI_PGAIN" value="1500"/>
    <define name="PSI_DGAIN" value="600"/>
    <define name="PSI_IGAIN" value="10"/>

    <!-- feedforward -->
    <define name="PHI_DDGAIN" value="0"/>
    <define name="THETA_DDGAIN" value="0"/>
    <define name="PSI_DDGAIN" value="100"/>
  </section>
  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="HOVER_KP" value="350" />
    <define name="HOVER_KD" value="85" />
    <define name="HOVER_KI" value="20" />
    <define name="NOMINAL_HOVER_THROTTLE" value="0.50" />
    <define name="ADAPT_THROTTLE_ENABLED" value="FALSE" />
  </section>
  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <!-- Good weather -->
    <define name="MAX_BANK" value="20" unit="deg" />
    <define name="REF_MAX_SPEED" value="2" unit="m/s" />
    <!-- Bad weather -->
    <!-- define name="MAX_BANK" value="32" unit="deg"/ -->
    <define name="PGAIN" value="50" />
    <define name="DGAIN" value="100" />
    <define name="IGAIN" value="30" />
  </section>
  <section name="NAVIGATION" prefix="NAV_">
    <define name="CLIMB_VSPEED" value="4.5" />
    <define name="DESCEND_VSPEED" value="-1.0" />
  </section>
  <section name="AUTOPILOT">
    <define name="MODE_STARTUP" value="AP_MODE_ATTITUDE_DIRECT" />
    <define name="MODE_MANUAL" value="AP_MODE_ATTITUDE_DIRECT" />
    <define name="MODE_AUTO1" value="AP_MODE_RC_DIRECT" />
    <define name="MODE_AUTO2" value="AP_MODE_RATE_DIRECT" />
<!--    <define name="MODE_AUTO2" value="AP_MODE_RATE_DIRECT" />-->
    <define name="NO_RC_THRUST_LIMIT" value="TRUE" />
  </section>
  <section name="BAT">
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="8700" />
    <define name="CATASTROPHIC_BAT_LEVEL" value="9.2" unit="V" />
    <define name="CRITIC_BAT_LEVEL" value="9.9" unit="V" />
    <define name="LOW_BAT_LEVEL" value="10.2" unit="V" />
    <define name="MAX_BAT_LEVEL" value="12.4" unit="V" />
  </section>
</airframe>
