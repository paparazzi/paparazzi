<!DOCTYPE airframe SYSTEM "../airframe.dtd">
<airframe name="mini_spirit">
  <description>
    About:
    Tiny blendedwing of EPP foam with Lisa MXS flightcontroller hardware

    !Specifications:
    + Model:       DF Mini Spirit 
    + FC:          Lisa MXS v1.0 with only a MPU6000, not a MPU9250
    + Actuators:   Default servos included with PNP set
    + GNSS         ublox M10
    + MAG          External RM3100 Magnetometer
    + ESC:         Default servos included with PNP set, must be set to fixed endpoints
    + BEC:         Tiny 2.5A BEC for Servos only
    + RCRX:        OpenRXSR Receiver
    + AIRSPEED:    No airspeed sensor
    + TELEMETRY:   Si10xx Chip based with firmware enabeling PPRZ RSSI message
    + CURRENT:     No current sensor
    + RANGER:      None
    + MOTOR:       Default DF-RC 1104 - 5700KV
    + PROP:        Small 4 blade

    !Notes:
    + CoG 95mm from nose
    + AP flipped 180 degrees, MCU is thus pointing down
    + Telemetry powered via BEC on flightcontrollen (100mAh max + MCU 60mAh is less than 250mAh, the max the DC converter can handle )
    + Flashing the firmware performed with Black Magic Probe (BMP) adapter
    + Uses PAPARAZZI standard radio channel settings
    + A 460mAh 2s1p LiPo battery, expect flighttimes of X minutes at X m/s

    !WIP:
    + Addition of pico Airspeed sensor sensirion SDP3x

    !Launching:
    1) Set TX to AUTO2, or if no TX it is AUTO2
    2) Move nose to ground
    3) wait until prop spins after a second or so,
    4) Position aircraft horizontally with slight pitch up
    5) Throw...
  </description>

  <firmware name="fixedwing">

    <target name="ap" board="lisa_mxs_1.0_chibios">
      <define name="REMAP_UART3" value="TRUE"/>
      <!--<configure name="FLASH_MODE" value="SWD"/>--> <!--Enable when flashing with black magic probe HWv1.0-->
      <!--<define name="USE_PERSISTENT_SETTINGS" value="TRUE"/>-->

      <!--<define name="AHRS_ALIGNER_SAMPLES_NB" value="600"/>-->
      <!--<define name="LOW_NOISE_THRESHOLD" value="30000"/>-->
      <!--<define name="LOW_NOISE_TIME" value="10"/>-->

      <configure name="CPU_LED" value="1"/> <!-- Change to whatever you like -->

      <!-- Note that PERIODIC_FREQUENCY should be least equal or greater than AHRS_PROPAGATE_FREQUENCY -->
      <configure name="PERIODIC_FREQUENCY" value="500"/>

      <define name="MPU_GYRO_RANGE" value="MPU60X0_GYRO_RANGE_2000"/>
      <define name="MPU_ACCEL_RANGE" value="MPU60X0_ACCEL_RANGE_16G"/>
      <!--
      <define name="IMU_MPU_LOWPASS_FILTER" value="MPU60X0_DLPF_256HZ"/>
      <define name="IMU_MPU_ACCEL_LOWPASS_FILTER" value="MPU60X0_DLPF_42HZ"/>
      <define name="IMU_MPU_SMPLRT_DIV" value="0"/>-->

      <!-- Best to use numbers from this list 1, 2, 4, 5, 10, 20, 25, 50, 100, 125, 250, 500 -->
      <configure name="AHRS_PROPAGATE_FREQUENCY" value="500"/>
      
      <configure name="AHRS_CORRECT_FREQUENCY" value="500"/>
      <configure name="AHRS_MAG_CORRECT_FREQUENCY" value="50"/>

      <configure name="NAVIGATION_FREQUENCY" value="20"/>
      <configure name="CONTROL_FREQUENCY" value="100"/>
      <configure name="TELEMETRY_FREQUENCY" value="50"/>
      <configure name="MODULES_FREQUENCY" value="500"/>

      <module name="imu" type="mpu6000">
        <define name="USE_SPI2"/>
        <define name="USE_SPI_SLAVE2"/>
        <configure name="IMU_MPU_SPI_DEV" value="spi2"/>
        <configure name="IMU_MPU_SPI_SLAVE_IDX" value="SPI_SLAVE2"/>
        <define name="IMU_MPU_CHAN_X" value="1"/>
        <define name="IMU_MPU_CHAN_Y" value="0"/>
        <define name="IMU_MPU_CHAN_Z" value="2"/>
        <define name="IMU_MPU_X_SIGN" value="-1"/>
        <define name="IMU_MPU_Y_SIGN" value="-1"/>
        <define name="IMU_MPU_Z_SIGN" value="-1"/>
        <!--MEDIAN_FILTER enabled since Lisa MXS flightcontroller mpu6000 chip often exhibits spikes in raw MPU sensor output that would mess-up the state completely-->
        <define name="IMU_MPU_USE_MEDIAN_FILTER" value="TRUE"/>
        <define name="IMU_MPU_GYRO_RANGE" value="MPU60X0_GYRO_RANGE_2000"/>
        <define name="IMU_MPU_ACCEL_RANGE" value="MPU60X0_ACCEL_RANGE_16G"/>
        <!-- Even dampned on sorbutane small cornerblocks set correct filter to avoid attitude runaway due to vibration -->
        <define name="IMU_MPU_LOWPASS_FILTER" value="MPU60X0_DLPF_42HZ"/>
        <define name="IMU_MPU_SMPLRT_DIV" value="0"/>
        <define name="IMU_MPU_ACCEL_LOWPASS_FILTER" value="MPU60X0_DLPF_ACC_44HZ"/>
      </module>

      <module name="mag" type="rm3100">
        <define name="USE_I2C1"/>
        <configure name="MAG_RM3100_PERIODIC_FREQUENCY" value="125"/>
        <configure name="MAG_RM3100_I2C_DEV" value="i2c1"/>
        <!-- <define name="RM3100_ADDR" value="RM3100_ADDR1"/> -->
        <!-- <define name="RM3100_DATA_RATE" value="RM3100_RATE_300"/> -->
        <define name="RM3100_USE_MEDIAN_FILTER" value="TRUE"/>  <!-- Enabled to avoid sporadic spikes in output-->  

        <define name="RM3100_CHAN_X" value="1"/>
        <define name="RM3100_CHAN_Y" value="0"/>
        <define name="RM3100_CHAN_Z" value="2"/>
        <define name="RM3100_CHAN_X_SIGN" value="-"/>
        <define name="RM3100_CHAN_Y_SIGN" value="+"/>
        <define name="RM3100_CHAN_Z_SIGN" value="-"/>

        <define name="MODULE_RM3100_UPDATE_AHRS" value="FALSE"/>
        <configure name="MODULE_RM3100_SYNC_SEND" value="TRUE"/>
      </module>

      <module name="baro_ms5611_spi">
        <configure name="MS5611_SPI_DEV" value="spi1"/>
        <configure name="MS5611_SLAVE_IDX" value="SPI_SLAVE3"/>
      </module>

      <module name="airspeed" type="sdp3x">
        <configure name="SDP3X_I2C_DEV" value="i2c1"/>
        <define name="SDP3X_I2C_ADDR" value="0x50"/>
        <define name="SDP3X_SYNC_SEND" value="FALSE"/>
        <define name="SDP3X_PRESSURE_SCALE" value="SDP3X_SCALE_PRESSURE_SDP33"/>
        <define name="SDP3X_PRESSURE_OFFSET" value="0.0"/>
        <define name="SDP3X_AIRSPEED_SCALE" value="1.6327"/>
        <define name="SDP3X_LOWPASS_TAU" value="0.15"/>
        <!--<define name="USE_AIRSPEED_LOWPASS_FILTER" value="FALSE">-->
        <define name="USE_AIRSPEED_SDP3X" value="TRUE"/>
      </module>

      <module name="actuators" type="pwm"/>

      <module name="gps" type="ublox">
        <configure name="GPS_PORT" value="UART3"/>
        <configure name="GPS_BAUD" value="B460800"/>
      </module>

      <module name="radio_control" type="ppm">
        <!-- for debugging PPM values as default setting, enable the one below but use with correct telemetry XML document-->
        <!--<define name="TELEMETRY_MODE_DEBUG_RC" value="TRUE"/>-->
        <!--<define name="RC_OK_CPT" value="25"/>--><!-- Switch back slower when entering RC range again to prevent flip flopping-->
        <!--<define name="RC_AVG_PERIOD" value="8"/>--> <!--if 60 Hz-val is 8-->
        <define name="RADIO_CONTROL_NB_CHANNEL" value="8"/>
        <configure name="RADIO_CONTROL_PPM_PIN" value="SERVO6"/>
        <define name="USE_PWM5" value="0"/> <!-- to enable PPM input disable PWM5-->
        <define name="USE_PWM6" value="0"/>
        <!-- Mode set one a three way switch -->
        <!-- Per default already GEAR if not defined  <define name="RADIO_MODE" value="RADIO_GEAR"/> --><!-- yes, already done by default if not redefined to something else-->
        <define name="RADIO_GEAR" value="RADIO_AUX2"/>
        <define name="RADIO_FLAP" value="RADIO_AUX3"/>
      </module>

      <!-- <module name="filter_1euro_imu">
        <define name="AHRS_ICQ_IMU_ID" value="IMU_F1E_ID"/>
        <define name="AHRS_ALIGNER_IMU_ID" value="IMU_F1E_ID"/> 
      </module>-->

      <!--<module name="flight_benchmark">
        <define name="BENCHMARK_AIRSPEED value="FALSE"/>
        <define name="BENCHMARK_ALTITUDE value="TRUE"/>
        <define name="BENCHMARK_POSITION value="TRUE"/>
        <define name="BENCHMARK_TOLERANCE_AIRSPEED" value="1" unit="m/s"/>
        <define name="BENCHMARK_TOLERANCE_ALTITUDE" value="3" unit="m"/>
        <define name="BENCHMARK_TOLERANCE_POSITION" value="4" unit="m"/>
      </module>-->

      <module name="sys_mon"/>

      <module name="telemetry" type="transparent">
        <configure name="MODEM_PORT" value="UART1"/>
        <configure name="MODEM_BAUD" value="B57600"/>
      </module>

    </target>

    <target name="sim" board="pc">
      <define name="INS_BARO_ID" value="BARO_SIM_SENDER_ID"/>
      <configure name="AHRS_PROPAGATE_FREQUENCY" value="500"/>
      <module name="radio_control" type="ppm"/>
      <define name="RADIO_GEAR" value="RADIO_AUX2"/>
      <define name="RADIO_FLAP" value="RADIO_AUX3"/>
      <define name="RADIO_CONTROL_NB_CHANNEL" value="8"/>
      <module name="telemetry" type="transparent"/>
      <module name="imu" type="sim"/>
      <module name="baro_sim"/>
      <module name="gps" type="ublox"/>
    </target>

    <target name="nps" board="pc">
      <configure name="PERIODIC_FREQUENCY" value="500"/>
      <configure name="AHRS_PROPAGATE_FREQUENCY" value="500"/>
      <module name="fdm" type="jsbsim"/>
      <module name="radio_control" type="ppm"/>
      <define name="RADIO_GEAR" value="RADIO_AUX2"/>
      <define name="RADIO_FLAP" value="RADIO_AUX3"/>
      <define name="RADIO_CONTROL_NB_CHANNEL" value="8"/>
      <define name="INS_BARO_ID" value="BARO_SIM_SENDER_ID"/>
      <module name="telemetry"   type="transparent"/>
      <module name="imu" type="nps"/>
      <module name="gps" type="ublox"/>
      <!--<define name="USE_NPS_AIRSPEED"/>
      <define name="USE_NPS_AOA"/>
      <define name="USE_NPS_SIDESLIP"/>
      <define name="NPS_SYNC_INCIDENCE"/>-->
      <!--<define name="INS_BARO_ID" value="BARO_SIM_SENDER_ID"/>-->
      <!-- Note NPS needs the ppm type radio_control module -->
      <!--<module name="radio_control" type="datalink"/>-->
      <module name="udp"/>
    </target>

    <define name="RADIO_CONTROL_AUTO1"/>

    <define name="AGR_CLIMB"/>
    <define name="TUNE_AGRESSIVE_CLIMB"/>

    <define name="STRONG_WIND"/>
    <define name="WIND_INFO"/>
    <define name="WIND_INFO_RET"/>

    <define name="autopilot_motors_on" value="TRUE"/>

    <configure name="USE_BARO_BOARD" value="TRUE"/>
    <define name="SENSOR_SYNC_SEND"/>
    <configure name="BARO_PERIODIC_FREQUENCY" value="50"/>
    <define name="USE_BARO_MEDIAN_FILTER"/>
    <define name="AUTOPILOT_DISABLE_AHRS_KILL"/>

    <define name="BAT_CHECKER_DELAY" value="80"/><!--unit="s/10" in tenth of seconds per default use ELECTRICAL_PERIODIC_FREQ if you for some reason want it differently-->
    <define name="CATASTROPHIC_BATTERY_KILL_DELAY" value="410"/><!--unit="s/10" in tenth of seconds for engine kill or in ELECTRICAL_PERIODIC_FREQ-->
    <define name="AHRS_TRIGGERED_ATTITUDE_LOOP"/>
    <define name="USE_AHRS_GPS_ACCELERATIONS" value="TRUE"/> <!-- forward acceleration compensation from GPS speed -->
    <define name="USE_MAGNETOMETER_ONGROUND" value="FALSE"/> <!--DEFINE only used if float_dcm Use magnetic compensation before takeoff only while GPS course not good -->
   <!-- If AHRS_MAG_CORRECT_FREQUENCY is set outside of target no need USE_MAGNETOMETER it is assumed TRUE -->
    <configure name="USE_MAGNETOMETER" value="FALSE"/><!-- should be as in USE the device-->

    <module name="ahrs" type="float_cmpl_quat"> <!-- Compare e.g. float_dcm, float_cmpl_quat -->
      <!--<define name="AHRS_ACCEL_ZETA" value="2.1"/>--><!-- default 0.063, see ahrs_float_cmpl.c -->
      <!--<define name="AHRS_ACCEL_OMEGA" value="0.1"/>--><!-- default 0.9, see ahrs_float_cmpl.c -->
      <configure name="AHRS_USE_MAGNETOMETER" value="FALSE"/>
      <!--<configure name="AHRS_ALIGNER_LED" value="2"/>-->
      <define name="AHRS_MAG_UPDATE_ALL_AXES" value="FALSE"/>
      <!--<define name="AHRS_USE_GPS_HEADING" value="FALSE"/>--><!-- TRUE per default -->
      <!--<define name="AHRS_GRAVITY_UPDATE_COORDINATED_TURN" value="TRUE"/>--><!-- already TRUE per default -->
      <define name="AHRS_GPS_SPEED_IN_NEGATIVE_Z_DIRECTION" value="FALSE"/>
      <!--<define name="AHRS_PROPAGATE_LOW_PASS_RATES" value="FALSE"/>-->
      <!--<define name="AHRS_BIAS_UPDATE_HEADING_THRESHOLD" value="0.174533"/>--><!--unit="rad"/-->
      <!--<define name="AHRS_HEADING_UPDATE_GPS_MIN_SPEED" value="0.0"/--> <!--unit="m/s"-->
      <!-- Some insights https://lists.nongnu.org/archive/html/paparazzi-devel/2013-10/msg00126.html -->
      <define name="AHRS_GRAVITY_HEURISTIC_FACTOR" value="0.0"/>
      <!-- <define name="AHRS_FC_MAG_ID" value="MAG_RM3100_SENDER_ID"/> -->
    </module>

    <module name="ins" type="alt_float">
      <define name="INS_PROPAGATE_FREQUENCY" value="500"/>
    </module>

    <module name="control" type="new"/>

    <!--<module name="imu_quality_assessment"/>--><!--NOTE NOT working for SIM, and disable after initial tuning-->

    <module name="auto1_commands"/>

    <module name="geo_mag"/>

    <module name="air_data"/>

    <module name="navigation"/>
    <!--<module name="nav" type="drop"/>-->
    <module name="nav" type="line"/>
    <module name="nav" type="line_border"/>
    <module name="nav" type="line_osam"/>
    <module name="nav" type="survey_polygon">
      <define name="POLYSURVEY_DEFAULT_DISTANCE" value="30"/>
    </module>
    <module name="nav" type="survey_poly_osam"/>
    <module name="nav" type="smooth"/>
    <module name="nav" type="vertical_raster"/>
    <module name="nav" type="flower"/>

    <!-- module name="nav" type="catapult"/> -->

    <!-- Quite a good alternative for the catapult module in this airfrsme -->
    <!--
    launch unit="rad"45deg Pitch angle for takeoff detection (sets 'launch' state to TRUE)
    Abort  unit="rad" -20deg Pitch angle to abort takeoff (set 'launch' to FALSE)
    Timer for takeoff detection in seconds (default 2s above pitch angle threshold)
    Disable Timer for module de-activation (default 4s after the launch detection)
    In Auto1 Sometimes throwing is not so easy :) so takeoff stabilized
      -->
    <!--
    <module name="takeoff_detect">
      <define name="TAKEOFF_DETECT_LAUNCH_PITCH" value="0.785398"/>
      <define name="TAKEOFF_DETECT_ABORT_PITCH" value="-0.349066"/> 
      <define name="TAKEOFF_DETECT_TIMER" value="1.2"/> 
      <define name="TAKEOFF_DETECT_DISABLE_TIMER" value="6.0"/> 
      <define name="TAKEOFF_DETECT_ALSO_IN_AUTO1" value="TRUE"/> 
    </module>-->

    <module name="photogrammetry_calculator"/>

    <!--<module name="digital_cam_video">
      <define name="DC_AUTOSHOOT_DISTANCE_INTERVAL" value="5.0"/>
    </module>-->

    <module name="traffic_info"/>
    <module name="tcas"/>
    <!--<module name="tune_airspeed"/>-->

  </firmware>

  <servos>
    <servo name="S_THROTTLE" no="0" min="1060" neutral="1080" max="1900"/> <!--fixed endpoints should be set in ESC in μs-->
    <servo name="S_ELEVON_LEFT" no="1" min="1900" neutral="1500" max="1100"/>
    <servo name="S_ELEVON_RIGHT" no="2" min="1100" neutral="1500" max="1900"/><!--neutral maybe 1450 in this arframe a new servo with no good midpoint-->
  </servos>

  <section name="ServoPositions">
    <!--  Just name a few,  value can be used in e.g. flightplan -->
    <define name="LANDINGGEAR_EXTEND" value="-MAX_PPRZ"/>
    <define name="LANDINGGEAR_RETRACT" value="MAX_PPRZ"/>
    <define name="FLAP_FULL" value="-MAX_PPRZ"/>
    <define name="FLAP_HALF" value="-MAX_PPRZ/2"/>
    <define name="FLAP_NONE" value="0"/>
    <define name="BEACON_ROTATE" value="MAX_PPRZ"/>
    <define name="BEACON_FLASH" value="0"/>
    <define name="BEACON_OFF" value="-MAX_PPRZ"/>

    <define name="SERVO_BRAKE_FULL" value="-MAX_PPRZ"/>
    <define name="SERVO_HATCH_OPEN" value="0"/>
    <define name="SERVO_HATCH_CLOSED" value="-9600"/>
    <define name="AirbrakesOff()" value="(commands[COMMAND_BRAKE]=0)"/>
    <define name="AirbrakesOn()" value="(commands[COMMAND_BRAKE]=SERVO_BRAKE_FULL)"/>
    <!--<define name="Fly()" value="(commands[COMMAND_FORCECRASH]=0)" />-->
    <!--<define name="ForceCrash()" value="(commands[COMMAND_FORCECRASH]=9600)" />-->
    <define name="ThrottleHigh()" value="(commands[COMMAND_THROTTLE]>MAX_PPRZ/2)"/>
    <define name="SPOILERON_BRAKE_FULL" value="-MAX_PPRZ"/>
    <define name="FLAPERON_BRAKE_FULL" value="MAX_PPRZ"/>
  </section>

  <!--For mixed servo controls -->
  <section name="MIXER">
    <define name="ELEVON_ROLL_FACTOR" value="0.8"/>
    <define name="ELEVON_PITCH_FACTOR" value="0.9"/>
    <define name="ELEVON_YAW_FACTOR" value="0.8"/>
    <!-- Set up/down deflection differences, needs many in flight tests to find acceptable values-->
    <define name="ELEVON_DIFF" value="0.3f"/> <!-- TODO: not used yet, not tuned yet... -->
  </section>

  <command_laws>
    <!-- 
    <let var="expo_pct_roll" value="0.9"/> 
    <let var="expo_pct_pitch" value="0.5"/>
    <let var="use_scaling" value="(1 > AP_MODE ? 1 : 0)"/>
    <let var="norm_roll"  value="@ROLL * 0.00010416666"/>
    <let var="norm_pitch" value="@PITCH * 0.00010416666"/>
    <let var="expo_roll"  value="$use_scaling = 1 ? (int32_t)($norm_roll * (1 - fabsf($expo_pct_roll)) + powf($norm_roll, 3) * $expo_pct_roll) : @ROLL"/>
    <let var="expo_pitch" value="$use_scaling = 1 ? (int32_t)($norm_pitch * (1 - fabsf($expo_pct_pitch)) + powf($norm_pitch, 3) * $expo_pct_pitch) : @PITCH"/>
    <let var="aileron"    value="($expo_roll * -ELEVON_ROLL_FACTOR)"/>
    <let var="elevator"   value="($expo_pitch * ELEVON_PITCH_FACTOR)"/>
    -->

    <let var="aileron" value="@ROLL * -ELEVON_ROLL_FACTOR"/> <!-- Mind the minus sign-->
    <let var="elevator" value="@PITCH * ELEVON_PITCH_FACTOR"/>

    <let var="leftyaw" value="(@YAW >= 0 ? 1 : 0)"/>
    <let var="rightyaw" value="(1 - $leftyaw)"/>
    <let var="rudderleft" value="(@YAW * $leftyaw) * ELEVON_YAW_FACTOR"/>
    <let var="rudderright" value="-(@YAW * $rightyaw) * ELEVON_YAW_FACTOR"/>
    <set servo="S_THROTTLE" value="@THROTTLE"/>
    <set servo="S_ELEVON_LEFT" value="$elevator - $aileron + $rudderleft"/>
    <set servo="S_ELEVON_RIGHT" value="$elevator + $aileron + $rudderright "/>
  </command_laws>

  <rc_commands>
    <set command="THROTTLE" value="@THROTTLE"/>
    <set command="ROLL" value="@ROLL"/>
    <set command="PITCH" value="@PITCH"/>
    <set command="YAW" value="@YAW*0.9"/>
    <set command="GEAR" value="@AUX2"/>
    <set command="FLAP" value="@AUX3"/>
  </rc_commands>

  <auto_rc_commands><!-- TODO: Disable later, now used to correct manually if tiny aircraft turn radius is not yet correcly tuned to be able keep it in sight -->
      <set command="YAW" value="@YAW*0.8"/>  
    <!-- To determine best pitch for flare in auto2 one can add Pitch command temporary while landing-->
    <!--<set command="PITCH" value="@PITCH"/>-->
  </auto_rc_commands>
  <!-- in PPRZ_MIN PPRZ_MAX range units-->
  <commands>
    <axis name="THROTTLE" failsafe_value="0"/>
    <axis name="ROLL" failsafe_value="700"/>
    <axis name="PITCH" failsafe_value="-500"/>
    <axis name="YAW" failsafe_value="0"/>
    <axis name="GEAR" failsafe_value="0"/>
    <axis name="FLAP" failsafe_value="0"/>
  </commands>

  <section name="AUTO1" prefix="AUTO1_">
    <define name="MAX_ROLL" value="70" unit="deg"/>
    <define name="MAX_PITCH" value="45" unit="deg"/>
  </section>

  <section name="TRIM" prefix="COMMAND_">
    <define name="ROLL_TRIM" value="0.0"/>
    <define name="PITCH_TRIM" value="0.0"/>
  </section>

  <section name="FAILSAFE" prefix="FAILSAFE_">
    <define name="DEFAULT_THROTTLE" value="0.0" unit="%"/>
    <define name="DEFAULT_GEAR" value="1100"/>
    <define name="DEFAULT_ROLL" value="15.0" unit="deg"/>
    <define name="DEFAULT_PITCH" value="-7.0" unit="deg"/>
    <define name="HOME_RADIUS" value="DEFAULT_CIRCLE_RADIUS" unit="m"/>
    <define name="KILL_MODE_DISTANCE" value="MAX_DIST_FROM_HOME*1.3+HOME_RADIUS" unit="m"/>
    <define name="DELAY_WITHOUT_GPS" value="6" unit="s"/>
  </section>

  <!--<section name="FILTER_1EURO" prefix="FILTER_1EURO_">
      <define name="ENABLED" value="TRUE"/>
      <define name="GYRO_MINCUTOFF" value="10."/>
      <define name="GYRO_BETA" value="0.05"/>
      <define name="ACCEL_MINCUTOFF" value="1.2"/>
      <define name="ACCEL_BETA" value="0.04"/>
  </section>-->

  <section name="IMU" prefix="IMU_">

    <!-- <define name="GYRO_P_SENS" value=" 1.01" integer="16"/> -->
    <!-- <define name="GYRO_Q_SENS" value=" 1.01" integer="16"/> -->
    <!-- <define name="GYRO_R_SENS" value=" 1.01" integer="16"/> -->
    <!-- <define name="GYRO_P_NEUTRAL" value="0"/> -->
    <!-- <define name="GYRO_Q_NEUTRAL" value="0"/> -->
    <!-- <define name="GYRO_R_NEUTRAL" value="0"/> -->

    <!-- Replace these values with your own calibration, on the correct sensor -->

    <!-- Accellometer Calibrated on 20230326 -->
    <!--<define name="IMU_ACCEL_CALIB" value="{{.abi_id=9, .calibrated={.neutral=true, .scale=true},.neutral={-13,-32,55}, .scale={{17709,55726,18931},{3607,11467,3912}}}}"/>-->
    <define name="ACCEL_X_NEUTRAL" value="-13"/>
    <define name="ACCEL_Y_NEUTRAL" value="-32"/>
    <define name="ACCEL_Z_NEUTRAL" value="55"/>
    <define name="ACCEL_X_SENS" value="4.85962019543351" integer="16"/>
    <define name="ACCEL_Y_SENS" value="4.859684306571929" integer="16"/>
    <define name="ACCEL_Z_SENS" value="4.8292126870247285" integer="16"/>

    <define name="BODY_TO_IMU_PHI" value="0.0" unit="deg"/><!--TODO RAD -->
    <define name="BODY_TO_IMU_THETA" value="7.0" unit="deg"/><!--TODO RAD -->
    <define name="BODY_TO_IMU_PSI" value="0.0" unit="deg"/><!--TODO RAD -->

    <!-- When build in differently to Rotate magneto compared to imu -90 degress -->
    <!--
    <define name="TO_MAG_PHI"   value="0." unit="deg"/>
    <define name="TO_MAG_THETA" value="0." unit="deg"/>
    <define name="TO_MAG_PSI"   value="90." unit="deg"/>
    -->

    <!-- External RM3100 calibrated 20230321 -->
    <!--  <define name="IMU_MAG_CALIB" value="{{.abi_id=5, .calibrated={.neutral=true, .scale=true},.neutral={-1618,-308,248}, .scale={{20498,26630,3979},{35871,47573,7204}}}}"/>-->

    <define name="MAG_X_NEUTRAL" value="-618"/>
    <define name="MAG_Y_NEUTRAL" value="-308"/>
    <define name="MAG_Z_NEUTRAL" value="248"/>
    <define name="MAG_X_SENS" value="0.5714365366588323" integer="16"/>
    <define name="MAG_Y_SENS" value="0.5597712987373732" integer="16"/>
    <define name="MAG_Z_SENS" value="0.5523320364279138" integer="16"/>
    
    <!-- TODO: Calibrate -->
    <!--
    on full throttle range with default battery 
    but only after airframe is fully finalized with
    all cables in fixed place -->
    <define name="MAG_X_CURRENT_COEF" value="0.0"/>
    <define name="MAG_Y_CURRENT_COEF" value="0.0"/>
    <define name="MAG_Z_CURRENT_COEF" value="0.0"/>

  </section>

    <!-- Rotation between sensor frame and IMU frame of this airframe external magnetometer -->
  <!--If you build in your GPS where the MAGNETOMETER resides on the board
  not alligned with the Accelo/Gyro axis or the main IMU on flight controller then set these values-->
  <section name="MAG_RM3100" prefix="RM3100_">
    <define name="MAG_TO_IMU_PHI" value="0.0"/>
    <define name="MAG_TO_IMU_THETA" value="0.0"/>
    <define name="MAG_TO_IMU_PSI" value="0.0"/>
  </section>

  <section name="AHRS" prefix="AHRS_">
    <!-- Local Magnetic field DE2023 -->
    <define name="H_X" value="0.413671"/>
    <define name="H_Y" value="-0.013374"/>
    <define name="H_Z" value="0.910328"/>
  </section>

  <section name="INS"> <!-- prefix="INS_"> -->
    <define name="INS_BODY_TO_GPS_X" value="0.0" unit="m"/>
    <define name="INS_BODY_TO_GPS_Y" value="0.16" unit="m"/>
    <define name="INS_BODY_TO_GPS_Z" value="0.0" unit="m"/>
    <define name="ROLL_NEUTRAL_DEFAULT" value="0." unit="deg"/>
    <define name="PITCH_NEUTRAL_DEFAULT" value="0." unit="deg"/><!-- not taken into account -->
    <define name="USE_GPS_ALT" value="TRUE"/>
    <define name="VFF_R_GPS" value="0.2"/>
    <!-- <define name="USE_GPS_ALT_SPEED" value="FALSE"/>--><!-- TODO: Check if good enough -->
  </section>

  <section name="HORIZONTAL CONTROL" prefix="H_CTL_">
    <define name="COURSE_PGAIN" value="0.98"/>
    <define name="COURSE_DGAIN" value="0.3"/>
    <define name="COURSE_TAU" value="0.5"/>
    <define name="COURSE_PRE_BANK_CORRECTION" value="1.02"/>

    <define name="ROLL_MAX_SETPOINT" value="45" unit="deg"/>
    <define name="PITCH_MAX_SETPOINT" value="40" unit="deg"/>
    <define name="PITCH_MIN_SETPOINT" value="-40" unit="deg"/>

    <define name="PITCH_PGAIN" value="7000"/>
    <define name="PITCH_DGAIN" value="80"/>
    <define name="PITCH_IGAIN" value="6"/>
    <define name="PITCH_KFFA" value="5."/>
    <define name="PITCH_KFFD" value="0."/>

    <!--<define name="ELEVATOR_OF_ROLL" value="1500" unit="PPRZ_MAX"/>-->
    <define name="ROLL_SLEW" value="0.3"/>
    <define name="ROLL_ATTITUDE_GAIN" value="11000."/>
    <define name="ROLL_RATE_GAIN" value="500."/>
    <define name="ROLL_IGAIN" value="20."/>
    <define name="ROLL_KFFA" value="10."/>
    <define name="ROLL_KFFD" value="0."/>
    <!--<define name="PITCH_OF_ROLL" value="2." unit="deg"/>--><!-- TODO: Tune -->
    <!--<define name="AILERON_OF_THROTTLE" value="0.0"/>--><!-- know what you do here, interesting results if set wrongly -->
  </section>

  <section name="VERTICAL CONTROL" prefix="V_CTL_">
    <define name="POWER_CTL_BAT_NOMINAL" value="7.6" unit="volt"/>
    <define name="ALTITUDE_PGAIN" value="0.1"/>
    <define name="AUTO_CLIMB_LIMIT" value="1.5*V_CTL_ALTITUDE_MAX_CLIMB"/>
    <define name="AUTO_THROTTLE_MIN_CRUISE_THROTTLE" value="0.50" unit="%"/>
    <define name="AUTO_THROTTLE_NOMINAL_CRUISE_THROTTLE" value="0.60" unit="%"/>
    <define name="AUTO_THROTTLE_MAX_CRUISE_THROTTLE" value="0.85" unit="%"/>

    <define name="AUTO_THROTTLE_LOITER_TRIM" value="1000" unit="pprz_t"/>
    <define name="AUTO_THROTTLE_DASH_TRIM" value="-2000" unit="pprz_t"/>
    <define name="AUTO_THROTTLE_CLIMB_THROTTLE_INCREMENT" value="0.30" unit="%/(m/s)"/>
    <define name="AUTO_THROTTLE_PGAIN" value="0.005" unit="%/(m/s)"/>
    <define name="AUTO_THROTTLE_IGAIN" value="0.002"/>
    <define name="AUTO_THROTTLE_DGAIN" value="0.0"/>
    <define name="AUTO_THROTTLE_PITCH_OF_VZ_PGAIN" value="0.09" unit="rad/(m/s)"/>
    <define name="AUTO_THROTTLE_NOMINAL_CRUISE_PITCH" value="0." unit="rad"/>
    <define name="THROTTLE_SLEW_LIMITER" value="0.5" unit="m/s/s"/>
    <define name="AUTO_AIRSPEED_SETPOINT" value="10.0" unit="m/s"/>
    <define name="AUTO_AIRSPEED_THROTTLE_PGAIN" value="0.12" unit="%/(m/s)"/>
    <define name="AUTO_AIRSPEED_THROTTLE_DGAIN" value="0.09"/>
    <define name="AUTO_AIRSPEED_THROTTLE_IGAIN" value="0.02"/>
    <define name="AUTO_AIRSPEED_PITCH_PGAIN" value="0.12" unit="degree/(m/s)"/>
    <define name="AUTO_AIRSPEED_PITCH_DGAIN" value="0.0"/>
    <define name="AUTO_AIRSPEED_PITCH_IGAIN" value="0.06"/>
    <define name="AIRSPEED_MAX" value="15.0" unit="m/s"/>
    <define name="AIRSPEED_MIN" value="8.0" unit="m/s"/>
    <define name="PITCH_LOITER_TRIM" value="0.5" unit="deg"/>
    <define name="PITCH_DASH_TRIM" value="0." unit="deg"/>
    <define name="AUTO_GROUNDSPEED_SETPOINT" value="5.0" unit="m/s"/>
    <define name="AUTO_GROUNDSPEED_PGAIN" value="0.8"/>
    <define name="AUTO_GROUNDSPEED_IGAIN" value="0.2"/>
    <define name="AIRSPEED_PGAIN" value="0.19"/>
    <define name="ALTITUDE_MAX_CLIMB" value="1.0" unit="m/s"/>
    <define name="MAX_ACCELERATION" value="0.8" unit="G"/>
    <define name="AUTO_PITCH_PGAIN" value="0.030"/>
    <define name="AUTO_PITCH_DGAIN" value="0.01"/>
    <define name="AUTO_PITCH_IGAIN" value="0.00"/>
    <!--define name="AUTO_PITCH_CLIMB_THROTTLE_INCREMENT" value="0.14"/-->
    <define name="AUTO_PITCH_MAX_PITCH" value="45" unit="deg"/>
    <define name="AUTO_PITCH_MIN_PITCH" value="-45" unit="deg"/>
    <!--  ETECS, not yet used -->
    <define name="ENERGY_TOT_PGAIN" value="0.35"/> 
    <define name="ENERGY_TOT_IGAIN" value="0.20"/> 
    <define name="ENERGY_DIFF_PGAIN" value="0.40"/> 
    <define name="ENERGY_DIFF_IGAIN" value="0.10"/> 

    <define name="GLIDE_RATIO" value="8."/>

    <define name="AUTO_THROTTLE_OF_AIRSPEED_PGAIN" value="0.06"/>
    <define name="AUTO_THROTTLE_OF_AIRSPEED_IGAIN" value="0.01"/>

    <define name="AUTO_PITCH_OF_AIRSPEED_PGAIN" value="0.01"/> 
    <define name="AUTO_PITCH_OF_AIRSPEED_IGAIN" value="0.003"/> 
    <define name="AUTO_PITCH_OF_AIRSPEED_DGAIN" value="0.03"/> 
  </section>

  <section name="AGGRESSIVE" prefix="AGR_">
    <define name="BLEND_START" value="30" unit="m"/>
    <define name="BLEND_END" value="10" unit="m"/>
    <define name="CLIMB_THROTTLE" value="0.85" unit="%"/>
    <define name="CLIMB_PITCH" value="45" unit="deg"/>
    <define name="DESCENT_THROTTLE" value="0.4" unit="%"/>
    <define name="DESCENT_PITCH" value="-30" unit="deg"/>
    <define name="CLIMB_NAV_RATIO" value="0.6" unit="%"/>
    <define name="DESCENT_NAV_RATIO" value="0.9" unit="%"/>
  </section>

  <section name="BAT">
    <!-- With our Lisa MXS the resistor devider is 10k and 17k to GND. 
    This goes to a max of 6.6v measururing, not enough for 2S we need a range to 8.4v
    So via e.g.  https://ohmslawcalculator.com/voltage-divider-calculator
    But we want 8.4v max that is 10k on one side and 6k6 on the other
    Looking at Lisa MXS schematics then R10 needs to be replaced by a 6k6 resistor
    Or place a reistor on top, easier soldering. 
    We had none, took the resistor R13 (~12k) from the unpopulated ranging pad, 
    That give us ~4k6 on R10 now. A bit of voltage resolution is lost but not noticably.
    Our multiplication factor is now ~0.0024123f
    -->
    <define name="VoltageOfAdc(adc)" value="(adc)*0.0024123f"/>
    <define name="MAX_BAT_CAPACITY" value="460" unit="mAh"/>
    <define name="MILLIAMP_AT_IDLE_THROTTLE" value="220" unit="mA"/><!-- The amps by AP+RX+ESC+Telemetry+Servos is not MOTOR power this substracted-->
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="6100" unit="mA"/><!-- 4 blade prop Motor amp draw at full Power static test at 7.6v -->
    <define name="CURRENT_ESTIMATION_NONLINEARITY" value="1.05"/>
    <define name="MAX_BAT_LEVEL" value="8.4" unit="V"/> <!-- 2S lipo 2x4.2 = 8.4 -->
    <!--<define name="BAT_NB_CELLS" value="2"/> -->
    <define name="LOW_BAT_LEVEL" value="7.2" unit="V"/> <!-- conservative since quick voltage dropoff at end of battery voltage -->
    <define name="CRITIC_BAT_LEVEL" value="6.6" unit="V"/>
    <define name="CATASTROPHIC_BAT_LEVEL" value="6.0" unit="V"/>
  </section>

  <section name="MISC">
    <!-- All for use with default motor and propeller -->
    <define name="MINIMUM_AIRSPEED" value="8.0" unit="m/s"/>
    <define name="NOMINAL_AIRSPEED" value="10.0" unit="m/s"/>
    <define name="MAXIMUM_AIRSPEED" value="15.0" unit="m/s"/>

    <define name="CLIMB_AIRSPEED" value="8.0" unit="m/s"/>
    <define name="TRACKING_AIRSPEED" value="12.0" unit="m/s"/>
    <define name="GLIDE_AIRSPEED" value="8.5" unit="m/s"/>
    <define name="STALL_AIRSPEED" value="7.0" unit="m/s"/>
    <define name="RACE_AIRSPEED" value="14.0" unit="m/s"/>
    <define name="MIN_SPEED_FOR_TAKEOFF" value="8.0" unit="m/s"/>
    <define name="AIRSPEED_SETPOINT_SLEW" value="0.3" unit="m/s/s"/>

    <define name="TAKEOFF_PITCH_ANGLE" value="25" unit="deg"/>
    <define name="FLARE_PITCH_ANGLE" value="5" unit="deg"/>
    <define name="NAV_GLIDE_PITCH_TRIM" value="2.0" unit="deg"/>

    <define name="KILL_MODE_DISTANCE" value="MAX_DIST_FROM_HOME*1.3+HOME_RADIUS" unit="m"/>  <!--  improve value by default turn radius calc -->
    <define name="DEFAULT_CIRCLE_RADIUS" value="70." unit="m"/>
    <define name="HOME_RADIUS" value="DEFAULT_CIRCLE_RADIUS" unit="m"/>
    <define name="LANDING_CIRCLE_RADIUS" value="60.0" unit="m"/>
    <define name="MIN_CIRCLE_RADIUS" value="50.0" unit="m"/>

    <define name="CARROT" value="4.0" unit="s"/>

    <define name="UNLOCKED_HOME_MODE" value="TRUE"/>
    <define name="RC_LOST_MODE" value="AP_MODE_AUTO2"/>
  </section>

  <section name="PHOTOGRAMMETRY" prefix="PHOTOGRAMMETRY_">
    <define name="FOCAL_LENGTH" value="2.5" unit="mm"/>
    <define name="SENSOR_WIDTH" value="2.304" unit="mm"/>
    <define name="SENSOR_HEIGHT" value="1.728" unit="mm"/>
    <define name="PIXELS_WIDTH" value="320"/>

    <!-- Photogrammetry Parameters. Can also be defined in a flightplan instead
    <define name="OVERLAP" value="0.3" unit="%"/>
    <define name="SIDELAP" value="0.2" unit="%"/>
    <define name="RESOLUTION" value="50" unit="mm pixel projection"/>
    -->
    <!-- note: only for PHOTOGRAMMETRY-->
    <define name="HEIGHT_MIN" value="50." unit="m"/>
    <define name="HEIGHT_MAX" value="120." unit="m"/>
    <define name="RADIUS_MIN" value="70." unit="m"/>
  </section>

  <section name="AIR_DATA" prefix="AIR_DATA_">
    <define name="CALC_AIRSPEED" value="FALSE"/>
    <define name="CALC_TAS_FACTOR" value="TRUE"/>
    <define name="CALC_AMSL_BARO" value="TRUE"/>
  </section>

  <!-- Can as well be your handlaunch, a.k.a. the human catapult ;) -->
  <section name="CATAPULT" prefix="NAV_CATAPULT_">
    <define name="MOTOR_DELAY" value="0." unit="s"/>
    <define name="HEADING_DELAY" value="3.0" unit="s"/>
    <define name="ACCELERATION_THRESHOLD" value="1.1"/>
    <define name="INITIAL_PITCH" value="20.0" unit="deg"/>
    <define name="INITIAL_THROTTLE" value="1.0"/>
  </section>

  <section name="GLS_APPROACH" prefix="APP_">
    <define name="DISTANCE_AF_SD" value="30" unit="m"/>
    <define name="ANGLE" value="2" unit="deg"/>
    <define name="INTERCEPT_AF_SD" value="80" unit="m"/>
    <!--<define name="INTERCEPT_RATE" value="0.624" unit="m/s/s"/>-->
    <define name="TARGET_SPEED" value="NOMINAL_AIRSPEED*1.05" unit="m/s"/>
  </section>

  <section name="GCS">
    <define name="SPEECH_NAME" value="Spirit"/>
    <define name="AC_ICON" value="flyingwing"/>
    <define name="ALT_SHIFT_PLUS_PLUS" value="30" unit="m"/>
    <define name="ALT_SHIFT_PLUS" value="10" unit="m"/>
    <define name="ALT_SHIFT_MINUS" value="-10" unit="m"/>
  </section>

  <section name="SIMU">
    <define name="JSBSIM_LAUNCHSPEED" value="NOMINAL_AIRSPEED" unit="m/s"/>
    <define name="WEIGHT" value="1."/>
    <define name="JSBSIM_IR_ROLL_NEUTRAL" value="RadOfDeg(0.0)"/>
    <define name="JSBSIM_IR_PITCH_NEUTRAL" value="RadOfDeg(0.0)"/>
    <define name="YAW_RESPONSE_FACTOR" value="0.9"/>
    <define name="PITCH_RESPONSE_FACTOR" value="1.0"/>
    <define name="ROLL_RESPONSE_FACTOR" value="20.0"/>
  </section>

  <section name="SIMULATOR" prefix="NPS_">
    <define name="JSBSIM_LAUNCHSPEED" value="NOMINAL_AIRSPEED"/>
    <define name="JSBSIM_MODEL" value="Malolo1" type="string"/>
    <define name="COMMANDS_NB" value="4"/>
    <define name="ACTUATOR_NAMES" value="throttle-cmd-norm, aileron-cmd-norm, elevator-cmd-norm, rudder-cmd-norm" type="string[]"/>
    <!--<define name="SENSORS_PARAMS" value="nps_sensors_params_default.h" type="string"/>-->
    <define name="JS_AXIS_MODE" value="4"/>
    <define name="BYPASS_AHRS" value="TRUE"/>
    <define name="BYPASS_INS" value="TRUE"/>
  </section>

</airframe>
