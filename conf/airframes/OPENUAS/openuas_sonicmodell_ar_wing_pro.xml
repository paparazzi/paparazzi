<!DOCTYPE airframe SYSTEM "../airframe.dtd">
<airframe name="AR_Wing_Pro">
  <description>
    Blendedwing airframe equipped with a mRo Pixracer flightcontroller hardware

    + MODEL:            Sonicmodell AR Wing Pro
    + FLIGHTCONTROLLER: PX4FMU 4.0 in the form of a mRo Pixracer v1.0 R15
    + ACTUATORS:        Default PNP set 9g servos
    + GNSS              Ublox M10 GNSS
    + MAGNETOMETER      IST8310
    + ESC:              Default PNP set ESC
    + RCRX:             OpenR-XSR
    + AIRSPEED:         Sensirion SDP33
    + TELEMETRY:        XBee Pro S1
    + CURRENT:          Standard Hextronix PowerBrick
    + RANGER:           Ultrasonic sensor on I2C
    + MOTOR:            Default PNP set 1400 RPM/V Outrunner Brushless
    + PROPELLER:        Default PNP set 2 blade thin electric 8x5"
    + BATTERY:          21700 Li-Ion 4x2 INR21700-M58T 5570 4S2P 11000mAh 3C 4C Burst battery pack

    NOTES:
    + Using Enahanced Total Energy control as control loop in Final AC
    + Servo pins point to back of the airframe
    + Engine battery voltage and current values via separate sensor on Powerbrick connected to FC default analog ports
    + Servos and ACL and position lights powered via BEC of ESC
    + Flightcontroller powered via Powerbrick
    + Telemetry powerd via BEC on Powerbrick
    + Uploading of the firmware can be performed via original PX4 or ARDU bootloader...
      Simple, USB cable in, upload... voila PPRZ aircraft on a Pixracer...
    + External IST8310 Magnetometer on GNSS device
    + GNSS set to ~19Hz update rate, 4 constelations, SBAS enabled
    + If testing "Classic" (as in not ETECS..) make sure to disable the settings/estimation/ac_char
    + Set the USE_AIRSPEED value to FALSE at first, for non airspeed testflights at first
    + Use also flightplan_versatile if no airspeed sensor is ues and use flightplan versatile_unified only with enabled airspeed sensor
    + When using multiple same aircraft hardware, set tweaked servo mid position by adjusting clevis rod length
  </description>

  <firmware name="fixedwing">

    <target name="ap" board="px4fmu_4.0_chibios">
      <!--<define name="USE_PERSISTENT_SETTINGS" value="TRUE"/>-->
      <!--<define name="DEBUG" value="TRUE"/>--><!--Enable for debug output, e.g. ms5611-->
      <!--<define name="USE_PERIODIC_TELEMETRY_REPORT" value="TRUE"/> -->

      <configure name="CPU_LED" value="1"/>

      <configure name="PERIODIC_FREQUENCY" value="500"/>

      <configure name="AHRS_PROPAGATE_FREQUENCY" value="500"/>
      <configure name="AHRS_CORRECT_FREQUENCY" value="500"/>
      <configure name="AHRS_MAG_CORRECT_FREQUENCY" value="50"/>
      <configure name="BARO_PERIODIC_FREQUENCY" value="50"/>

      <configure name="NAVIGATION_FREQUENCY" value="20"/>
      <configure name="CONTROL_FREQUENCY" value="100"/>
      <configure name="TELEMETRY_FREQUENCY" value="50"/>
      <configure name="MODULES_FREQUENCY" value="500"/>

      <module name="imu" type="mpu9250_spi">
        <configure name="IMU_MPU9250_SPI_DEV" value="spi1"/>
        <configure name="IMU_MPU9250_SPI_SLAVE_IDX" value="SPI_SLAVE2"/>
        <define name="IMU_MPU9250_READ_MAG" value="FALSE"/><!-- False, since using external MAG only -->
        <define name="IMU_MPU9250_GYRO_RANGE" value="MPU9250_GYRO_RANGE_2000" />
        <define name="IMU_MPU9250_ACCEL_RANGE" value="MPU9250_ACCEL_RANGE_16G" />
      </module>

      <module name="mag" type="ist8310">
        <define name="MODULE_IST8310_UPDATE_AHRS" value="FALSE"/><!-- not yet for now-->
        <configure name="MAG_IST8310_PERIODIC_FREQUENCY" value="50"/>
        <configure name="MAG_IST8310_I2C_DEV" value="i2c1"/>
        <define name="IST8310_CHAN_X" value="0"/>
        <define name="IST8310_CHAN_Y" value="1"/>
        <define name="IST8310_CHAN_Z" value="2"/>
        <define name="IST8310_CHAN_X_SIGN" value="+"/>
        <define name="IST8310_CHAN_Y_SIGN" value="-"/>
        <define name="IST8310_CHAN_Z_SIGN" value="+"/>
        <!--<define name="MODULE_IST8310_SYNC_SEND" value="TRUE"/>--> <!--Only enable while debugging -->
      </module> 

      <module name="baro_ms5611_spi">
        <configure name="MS5611_SPI_DEV" value="spi1"/>
        <configure name="MS5611_SLAVE_IDX" value="SPI_SLAVE3"/>
        <!--<define name="SENSOR_SYNC_SEND" value="TRUE"/>--><!-- TODO: Disable after all tuning is done -->
      </module>

      <!-- Enable this module for debugging the raw ADC values, handy to determin e.g. Current sensor scale factor... -->
      <!-- <module name="adc_generic">
        <configure name="USE_RSSI_IN" value="TRUE"/> -->
        <!-- <configure name="USE_ADC_2" value="TRUE"/> -->
        <!-- <configure name="USE_ADC_4" value="TRUE"/> -->
        <!-- <configure name="ADC_CHANNEL_GENERIC1" value="ADC_1"/> -->
        <!-- <configure name="ADC_CHANNEL_GENERIC2" value="ADC_3"/> -->
        <!-- <configure name="ADC_CHANNEL_GENERIC1" value="RSSI_IN"/>
        <configure name="ADC_CHANNEL_GENERIC2" value="ADC_2"/>
      </module> -->

      <configure name="USE_ADC_1" value="TRUE"/>
      <define name="ADC_CHANNEL_VSUPPLY" value="ADC_1"/>

      <module name="current_sensor">
        <configure name="USE_ADC_2" value="TRUE"/>
        <configure name="ADC_CURRENT_SENSOR" value="ADC_2"/>
      </module>

      <!-- TODO: Fix driver and PR for GY-US42V2 -->
      <!-- <module name="sonar_i2c"> 
        <configure name="SONAR_I2C_DEV" value="i2c1"/>
        <configure name="SONAR_I2C_ADDR" value="0xE0"/>
        <configure name="USE_SONAR_I2C_AGL" value="FALSE"/>
        <configure name="SONAR_I2C_COMPENSATE_ROTATION" value="FALSE"/>
        <define name="SONAR_I2C_USE_FILTER" value="FALSE"/>
        <define name="AGL_SONAR_I2C_ID" value="254"/>
        <define name="SONAR_I2C_OFFSET" value="0.06"/> -->
        <!-- <define name="SONAR_SCALE" value="1.0"/>
        <define name="SONAR_I2C_MIN_RANGE" value="0.25"/>
        <define name="SONAR_I2C_MAX_RANGE" value="5.0"/> -->
        <!-- <define name="SONAR_I2C_MEDIAN_SIZE" value="6"/> -->
        <!-- <define name="SENSOR_SYNC_SEND_SONAR"/> -->
      <!-- </module> -->

      <module name="actuators" type="pwm"/>
 
      <!-- TODO: determin pitot to tube length difference margin -->
      <module name="airspeed" type="sdp3x">
        <configure name="SDP3X_I2C_DEV" value="i2c1"/>
        <!-- <define name="SDP3X_I2C_ADDR" value="0x50"/> --> <!-- 0x50 is the default address -->
        <!-- <define name="SDP3X_PRESSURE_SCALE" value="1.0"/> --> <!-- pressure scaling factor to convert raw output to Pa (default: set according to pressure range and output type according to datasheet) -->
        <!---<define name="SDP3X_PRESSURE_OFFSET" value="0.0"/>--> <!-- pressure offset in Pa (default: set according to pressure range and output type according to datasheet) -->
        <!-- <define name="SDP3X_AIRSPEED_SCALE" value="1.6327"/> --> <!-- quadratic scale factor to convert differential pressure to airspeed -->
        <define name="SDP3X_LOWPASS_TAU" value="0.07"/>
        <define name="USE_AIRSPEED_SDP3X" value="TRUE"/>
        <define name="USE_AIRSPEED" value="TRUE"/>
        <define name="SDP3X_PRESSURE_SCALE" value="SDP3X_SCALE_PRESSURE_SDP33"/>
        <!--<define name="SDP3X_SYNC_SEND" value="TRUE"/>--> <!-- Only enable when debuggging -->
      </module>

      <module name="gps" type="ublox">
        <configure name="GPS_BAUD" value="B460800"/>
      </module>

      <!-- SBUS out is AETR by default, our transmitter sends TAER to multimodule as per standard so correct in radio file -->
      <module name="radio_control" type="sbus">
        <define name="RADIO_CONTROL_NB_CHANNEL" value="16"/>  <!--Optionally Set the OpenRXSR receiver to maximum channel output of 8 9ms -->
        <!-- Mode must be set one a BLUE three way switch -->
        <define name="RADIO_GEAR" value="RADIO_AUX2"/>
        <define name="RADIO_FLAP" value="RADIO_AUX3"/>
        <define name="RADIO_MANUALRELEASE" value="RADIO_AUX6"/>
        <define name="RADIO_LIGHTS" value="RADIO_AUX2"/>
      </module>

      <!-- Only enable with a module that supports v_ctl_auto_airspeed_setpoint-->
      <!--<module name="flight_benchmark">
        <define name="BENCHMARK_AIRSPEED" value="TRUE"/>
        <define name="BENCHMARK_ALTITUDE" value="TRUE"/>
        <define name="BENCHMARK_POSITION" value="TRUE"/>
        <define name="BENCHMARK_TOLERANCE_AIRSPEED" value="1" unit="m/s"/>
        <define name="BENCHMARK_TOLERANCE_ALTITUDE" value="4" unit="m"/>
        <define name="BENCHMARK_TOLERANCE_POSITION" value="6" unit="m"/>
      </module>-->

      <module name="sys_mon"/>

      <!-- Desktesting-->
      <!-- <module name="telemetry" type="transparent">
        <configure name="MODEM_PORT" value="usb_serial"/>
      </module> -->

        <!-- UART3 is labeled  Telem2  on Pixracer FC -->
      <module name="telemetry" type="transparent">
        <configure name="MODEM_PORT" value="UART3"/>
        <configure name="MODEM_BAUD" value="B57600"/>
      </module>

      <!-- <module name="telemetry" type="xbee_api">
        <define name="XBEE_CHANNEL" value="0E"/>  
        <define name="XBEE_INIT" value="\"ATID3332\rATPL5\r\"" type="string"/>
        <configure name="MODEM_PORT" value="UART3"/>
        <configure name="MODEM_BAUD" value="B57600"/>
      </module> -->

      <!-- The Pixracer has a built in SD card slot connected over SPI bus to the MCU -->
      <!-- For testflights this might come in handy to analyze flight data -->
      <!-- <module name="tlsf"/>
      <module name="pprzlog"/>
      <module name="logger" type="sd_chibios">
        <define name="SDLOG_START_DELAY" value="5" unit="s"/>
        <define name="SDLOG_AUTO_FLUSH_PERIOD" value="4"/>
      </module> -->

      <!-- use the paprazzi/sd2log tool to convert log to be able to use in logplotter as normal -->
      <!-- <module name="flight_recorder"/> -->

      <!-- Below example of what to add to your telemetry_something.xml file
      <process name="FlightRecorder">
        <mode name="default">
          <message name="FBW_STATUS"          period="1.2"/>
          <message name="DL_VALUE"            period="0.5"/>
          <message name="IMU_ACCEL"           period="0.05"/>
          <message name="IMU_GYRO"            period="0.05"/>
          <message name="IMU_MAG"             period="0.1"/>
          <message name="IMU_ACCEL_RAW"       period="0.002"/>
          <message name="IMU_GYRO_RAW"        period="0.002"/>
          <message name="IMU_MAG_RAW"         period="0.002"/>
          <message name="COMMANDS"            period=".002"/>
        </mode>
      </process>
      -->

      <!-- An alternative for the catapult module in some cases -->
       <!-- Sometimes throwing is not so easy :) so takeoff stabilized therfoe Also in auto1-->
      <!-- <module name="takeoff_detect">
        <define name="TAKEOFF_DETECT_LAUNCH_PITCH" value="0.785398"/>
        <define name="TAKEOFF_DETECT_ABORT_PITCH" value="-0.349066"/>
        <define name="TAKEOFF_DETECT_TIMER" value="1.2"/>
        <define name="TAKEOFF_DETECT_DISABLE_TIMER" value="5.0"/>
        <define name="TAKEOFF_DETECT_ALSO_IN_AUTO1" value="TRUE"/> 
      </module> -->

    </target>

    <target name="sim" board="pc">
      <define name="INS_BARO_ID" value="BARO_SIM_SENDER_ID"/>
      <configure name="AHRS_PROPAGATE_FREQUENCY" value="500"/>
      <module name="radio_control" type="ppm"/>
      <define name="RADIO_GEAR" value="RADIO_AUX2"/>
      <define name="RADIO_FLAP" value="RADIO_AUX3"/>
      <define name="RADIO_MANUALRELEASE" value="RADIO_AUX6"/>
      <define name="RADIO_LIGHTS" value="RADIO_AUX3"/>     
      <!--<define name="RADIO_CONTROL_NB_CHANNEL" value="8"/>-->
      <module name="telemetry" type="transparent"/>
      <module name="imu_nps"/><!-- Should be sim not nps to be consistent for PPRZ -->
      <module name="baro_sim"/>
      <module name="gps" type="ublox"/>
    </target>

    <define name="USE_AIRSPEED" value="TRUE"/>

    <define name="RADIO_CONTROL_AUTO1"/>

    <define name="AGR_CLIMB"/>
    <define name="TUNE_AGRESSIVE_CLIMB"/>

    <define name="STRONG_WIND"/>
    <define name="WIND_INFO"/>
    <define name="WIND_INFO_RET"/>

    <define name="autopilot_motors_on" value="TRUE"/>

    <configure name="USE_BARO_BOARD" value="TRUE"/>
    <configure name="USE_MAGNETOMETER" value="FALSE"/>

    <define name="USE_BARO_MEDIAN_FILTER"/>
    <define name="AUTOPILOT_DISABLE_AHRS_KILL"/>
    <define name="BAT_CHECKER_DELAY" value="80"/>
    <define name="CATASTROPHIC_BATTERY_KILL_DELAY" value="600"/>
    <define name="AHRS_TRIGGERED_ATTITUDE_LOOP"/>
    <define name="USE_AHRS_GPS_ACCELERATIONS" value="TRUE"/>
    <define name="USE_MAGNETOMETER_ONGROUND" value="FALSE"/>

    <module name="ahrs" type="float_cmpl_quat">
      <configure name="AHRS_ALIGNER_LED" value="2"/>
      <!-- <configure name="AHRS_USE_MAGNETOMETER" value="TRUE"/> -->
      <define name="AHRS_FC_MAG_ID" value="MAG_IST8310_SENDER_ID"/>
      <!-- <define name="USE_AHRS_GPS_ACCELERATIONS"/>--><!-- TODO: check if needed -->
    </module>

    <module name="ins" type="alt_float">
      <define name="INS_PROPAGATE_FREQUENCY" value="500"/>
      <define name="SONAR_COMPENSATE_ROTATION" value="TRUE"/><!-- compensate AGL for body rotation -->
    </module>

    <!-- <module name="control" type="energy"/> --><!--TODO: Enable later if basics work -->
    <module name="control" type="new"/>

    <module name="geo_mag"/>
    <module name="air_data"/>

    <module name="navigation"/>
    <module name="nav" type="drop"/>
    <module name="nav" type="line"/>
    <module name="nav" type="line_border"/>
    <module name="nav" type="line_osam"/>
    <module name="nav" type="survey_polygon">
      <define name="POLYSURVEY_DEFAULT_DISTANCE" value="40"/>
    </module>
    <module name="nav" type="survey_poly_osam"/>
    <module name="nav" type="smooth"/>
    <module name="nav" type="vertical_raster"/>
    <module name="nav" type="flower"/>
    <module name="nav" type="bungee_takeoff"/>

    <module name="agl_dist">
      <define name="USE_SONAR"/>
    </module>

    <module name="photogrammetry_calculator"/>
    <module name="traffic_info"/>
    <module name="tcas"/>

    <module name="tune_airspeed"/> <!-- TODO: Disable after initial tuning -->

  </firmware>

  <servos>
    <!-- Define here to which CONNECTOR NUMBER the servo is connected to, on the autopilot cicuit board -->
    <servo name="S_THROTTLE"       no="0" min="1000" neutral="1150" max="1900"/>
    <servo name="S_ELEVON_LEFT"    no="1" min="1900" neutral="1540" max="1100"/>
    <servo name="S_ELEVON_RIGHT"   no="2" min="1100" neutral="1460" max="1900"/>
    <servo name="S_HATCH"          no="3" min="1100" neutral="1110" max="1900"/>
    <servo name="S_ACL"            no="4" min="1000" neutral="1500" max="2000"/>
    <servo name="S_TAIL_POS_LIGHT" no="5" min="1000" neutral="1500" max="2000"/>
  </servos>

  <section name="ServoPositions">
    <!--  Just name a few, these definitions terms can be used in e.g. flightplan -->
    <define name="LANDINGGEAR_EXTEND" value="MIN_PPRZ"/>
    <define name="LANDINGGEAR_RETRACT" value="MAX_PPRZ"/>
    <define name="FLAP_FULL" value="MIN_PPRZ"/>
    <define name="FLAP_HALF" value="MIN_PPRZ/2"/>
    <define name="FLAP_NONE" value="0"/>
    <define name="BEACON_ROTATE" value="MAX_PPRZ"/>
    <define name="BEACON_FLASH" value="0"/>
    <define name="BEACON_OFF" value="MIN_PPRZ"/>

    <define name="SERVO_BRAKE_FULL" value="MIN_PPRZ"/>
    <define name="SERVO_HATCH_OPEN" value="0"/>
    <define name="SERVO_HATCH_CLOSED" value="MIN_PPRZ"/>
    <!-- <define name="AirbrakesOff()" value="(commands[COMMAND_BRAKE]=0)"/> -->
    <!-- <define name="AirbrakesOn()" value="(commands[COMMAND_BRAKE]=SERVO_BRAKE_FULL)"/> -->
    <!-- <define name="Fly()" value="(commands[COMMAND_FORCECRASH]=0)"/> -->
    <!-- <define name="ForceCrash()" value="(commands[COMMAND_FORCECRASH]=9600)" /> -->
    <define name="ThrottleHigh()" value="(commands[COMMAND_THROTTLE]>MAX_PPRZ/2)"/>
    <define name="SPOILERON_BRAKE_FULL" value="MIN_PPRZ"/>
    <define name="FLAPERON_BRAKE_FULL" value="MAX_PPRZ"/>
  </section>

  <section name="MIXER">
    <define name="ELEVON_ROLL_FACTOR" value="0.9f"/>
    <define name="ELEVON_PITCH_FACTOR" value="0.8f"/>
    <define name="ELEVON_YAW_FACTOR" value="0.7f"/>
    <define name="ELEVON_DIFF" value="0.3f"/> <!-- Blendedwing, not needed, therefor not used -->
  </section>

  <command_laws>
    <let var="aileron" value="-@ROLL * ELEVON_ROLL_FACTOR"/>
    <let var="elevator" value="-@PITCH * ELEVON_PITCH_FACTOR"/>
    <let var="leftyaw" value="(@YAW >= 0 ? 0 : 1)"/>
    <let var="rightyaw" value="(1 - $leftyaw)"/>
    <let var="rudderleft" value="(@YAW * $leftyaw)"/>
    <let var="rudderright" value="-(@YAW * $rightyaw)"/>
    <set servo="S_THROTTLE" value="@THROTTLE"/>
    <set servo="S_ELEVON_LEFT"  value="$elevator - $aileron + $rudderleft"/>
    <set servo="S_ELEVON_RIGHT" value="$elevator + $aileron + $rudderright "/>
    <set servo="S_HATCH" value="(Or((autopilot.mode == AP_MODE_AUTO1), (autopilot.mode == AP_MODE_AUTO2)) ? MAX_PPRZ : @HATCH)"/>
    <!--<set servo="S_ACL" value="(Or((autopilot.mode == AP_MODE_AUTO1), (autopilot.mode == AP_MODE_AUTO2)) ? MAX_PPRZ : @HATCH)"/>--><!-- Enable for temporary test  with light -->
    <set servo="S_ACL" value="((autopilot.mode == AP_MODE_AUTO2) ? MAX_PPRZ : @ACTIVELIGHTS)"/>
    <set servo="S_TAIL_POS_LIGHT" value="(Or((autopilot.mode == AP_MODE_AUTO1), (autopilot.mode == AP_MODE_AUTO2)) ? MAX_PPRZ : @ACTIVELIGHTS)"/>
  </command_laws>

  <rc_commands>
    <set command="THROTTLE" value="@THROTTLE"/>
    <set command="ROLL" value="@ROLL"/>
    <set command="PITCH" value="@PITCH"/>
    <set command="YAW" value="@YAW*0.6"/>
    <set command="HATCH" value="@MANUALRELEASE"/>
    <set command="CLICKSHUTTER" value="@MANUALRELEASE"/>
    <set command="ACTIVELIGHTS" value="@LIGHTS"/>
  </rc_commands>

  <auto_rc_commands>
    <set command="YAW" value="@YAW*0.8"/><!-- can be disabled after all tuning-->
    <!-- To determine best pitch for flare in auto2 one can add Pitch command temporary while landing-->
    <!--WARNING only enable if you know why <set command="PITCH" value="@PITCH"/>-->
  </auto_rc_commands>

  <commands>
    <axis name="THROTTLE" failsafe_value="0"/>
    <axis name="ROLL" failsafe_value="700"/>
    <axis name="PITCH" failsafe_value="-500"/>
    <axis name="YAW" failsafe_value="0"/>
    <!-- <axis name="GEAR" failsafe_value="0"/>
    <axis name="FLAP" failsafe_value="0"/> -->
    <axis name="HATCH" failsafe_value="-9599"/>
    <axis name="CLICKSHUTTER" failsafe_value="-9599"/>
    <axis name="ACTIVELIGHTS" failsafe_value="0"/>
  </commands>

  <section name="AUTO1" prefix="AUTO1_">
    <define name="MAX_ROLL" value="60" unit="deg"/>
    <define name="MAX_PITCH" value="50" unit="deg"/>
  </section>

  <section name="TRIM" prefix="COMMAND_">
    <define name="ROLL_TRIM" value="0.0"/>
    <define name="PITCH_TRIM" value="0.0"/>
  </section>

  <section name="FAILSAFE" prefix="FAILSAFE_">
    <define name="DEFAULT_THROTTLE" value="0.0" unit="%"/>
    <define name="DEFAULT_GEAR" value="1100"/>
    <define name="DEFAULT_ROLL" value="12.0" unit="deg"/>
    <define name="DEFAULT_PITCH" value="-4.0" unit="deg"/>
    <define name="HOME_RADIUS" value="DEFAULT_CIRCLE_RADIUS" unit="m"/>
    <define name="KILL_MODE_DISTANCE" value="MAX_DIST_FROM_HOME*1.3+HOME_RADIUS" unit="m"/>
    <define name="DELAY_WITHOUT_GPS" value="4" unit="s"/>
  </section>

  <section name="IMU" prefix="IMU_">

    <!-- <define name="GYRO_P_SENS" value=" 1.01" integer="16"/> -->
    <!-- <define name="GYRO_Q_SENS" value=" 1.01" integer="16"/> -->
    <!-- <define name="GYRO_R_SENS" value=" 1.01" integer="16"/> -->
    <!-- <define name="GYRO_P_NEUTRAL" value="0"/> -->
    <!-- <define name="GYRO_Q_NEUTRAL" value="0"/> -->
    <!-- <define name="GYRO_R_NEUTRAL" value="0"/> -->

    <!-- Calibrated 20240904-0032 --> 
    <!--
    <define name="IMU_ACCEL_CALIB" type="array"/>
      <field type="struct"/>
        <field name="abi_id" value="11"/>
        <field name="calibrated" type="struct">
          <field name="neutral" value="true"/>
          <field name="scale" value="true"/>
        </field>
        <field name="neutral" value="11,42,12" type="int[]"/>
        <field name="scale" value="{{32168,39220,47085},{6577,8009,9748}}"/>
      </field>
    </define>
    -->
  
    <define name="ACCEL_X_NEUTRAL" value="9"/>
    <define name="ACCEL_Y_NEUTRAL" value="39"/>
    <define name="ACCEL_Z_NEUTRAL" value="10"/>
    <define name="ACCEL_X_SENS" value="4.890983733182881" integer="16"/>
    <define name="ACCEL_Y_SENS" value="4.896990884116391" integer="16"/>
    <define name="ACCEL_Z_SENS" value="4.85022159024262" integer="16"/>

    <define name="BODY_TO_IMU_PHI" value="0.0" unit="deg"/>
    <define name="BODY_TO_IMU_THETA" value="3.0" unit="deg"/>
    <define name="BODY_TO_IMU_PSI" value="0.0" unit="deg"/>

    <!-- Calibrated on 20240910 11:45. Extrem hard-iron offset due to magnets close by, room for improvement-->
    
    <define name="IMU_MAG_CALIB" type="array">
      <field type="struct">
        <field name="abi_id" value="4"/>
        <field name="calibrated" type="struct">
          <field name="neutral" value="true"/>
          <field name="scale" value="true"/>
        </field>
        <field name="neutral" value="316,4,546" type="int[]"/>
        <field name="scale" value="{{27681,24283,48131},{2143,1853,3757}}"/>
      </field>
    </define>
   
    <define name="MAG_X_NEUTRAL" value="316"/>
    <define name="MAG_Y_NEUTRAL" value="4"/>
    <define name="MAG_Z_NEUTRAL" value="546"/>
    <define name="MAG_X_SENS" value="12.916938861242496" integer="16"/>
    <define name="MAG_Y_SENS" value="13.104695106331626" integer="16"/>
    <define name="MAG_Z_SENS" value="12.811019425765746" integer="16"/>

    <!-- TODO: Calibrate -->
    <!-- 
    <define name="MAG_X_CURRENT_COEF" value="-0.677655963532"/>
    <define name="MAG_Y_CURRENT_COEF" value="-7.38678178538"/>
    <define name="MAG_Z_CURRENT_COEF" value="-5.02116042576"/> 
    -->

  </section>

  <section name="AHRS" prefix="AHRS_">
    <!--<define name="GRAVITY_UPDATE_COORDINATED_TURN" value="TRUE"/>--><!--Already TRUE by default Compensation of centrifugal force via GPS speed (to fly in circles with a fixedwing) -->
    <define name="GRAVITY_HEURISTIC_FACTOR" value="0"/>
    <define name="GPS_SPEED_IN_NEGATIVE_Z_DIRECTION" value="FALSE"/>
    <!-- <define name="HEADING_UPDATE_GPS_MIN_SPEED" value="3.0"/> -->
    <!-- <define name="PROPAGATE_LOW_PASS_RATES" value="TRUE"/> -->
    <!-- <define name="PROPAGATE_LOW_PASS_RATES_MUL" value="19"/> -->
    <!-- <define name="PROPAGATE_LOW_PASS_RATES_DIV" value="20"/> -->

    <!-- Local Magnetic field DE2024 -->
    <define name="H_X" value="0.413671"/>
    <define name="H_Y" value="-0.013374"/>
    <define name="H_Z" value="0.910328"/>
  </section>

  <section name="INS">
    <define name="INS_BODY_TO_GPS_X" value="0.05" unit="m"/>
    <define name="INS_BODY_TO_GPS_Y" value="0.0" unit="m"/>
    <define name="INS_BODY_TO_GPS_Z" value="0.06" unit="m"/>

    <!-- <define name="USE_INS_MODULE"/> -->

    <define name="ROLL_NEUTRAL_DEFAULT" value="0." unit="deg"/>
    <define name="PITCH_NEUTRAL_DEFAULT" value="0." unit="deg"/><!--TODO: test for 3 deg-->
    <define name="USE_GPS_ALT" value="TRUE"/>
    <!--<define name="USE_GPS_ALT_SPEED" value="FALSE"/>-->
    <!--<define name="VFF_R_GPS" value="0.03"/>--><!-- If one trusts baro a bit more -->
    <define name="VFF_R_GPS" value="0.25"/>
    <!--<define name="VFF_VZ_R_GPS" value="0.2"/>-->

    <define name="INS_SONAR_MAX_RANGE" value="6.0"/>
    <define name="INS_SONAR_MIN_RANGE" value="0.15"/>
  </section>

  <section name="SONAR" prefix="SONAR_">
    <define name="MEDIAN_SIZE" value="15"/>
    <define name="COMPENSATE_ROTATION" value="TRUE"/>
    <define name="SCALE" value="0.0025375" integer="16"/>
    <define name="OFFSET" value="0.1"/>
    <define name="MAX_RANGE" value="6.2" unit="m"/>
    <define name="MIN_RANGE" value="0.20" unit="m"/>
  </section>

  <section name="AGL" prefix="AGL_DIST_SONAR_">
    <define name="ID" value="ABI_BROADCAST"/>
    <define name="MAX_RANGE" value="6.0" unit="m"/>
    <define name="MIN_RANGE" value="0.25" unit="m"/>
    <!--<define name="FILTER" value="0.5"/>-->
  </section>

  <section name="HORIZONTAL CONTROL" prefix="H_CTL_">
    <define name="COURSE_PGAIN" value="0.90"/>
    <define name="COURSE_DGAIN" value="0.16"/>
    <define name="COURSE_TAU" value="0.4"/><!-- not used anymore -->
    <define name="COURSE_PRE_BANK_CORRECTION" value="0.99"/>

    <define name="ROLL_MAX_SETPOINT" value="50" unit="deg"/>
    <define name="PITCH_MAX_SETPOINT" value="40" unit="deg"/>
    <define name="PITCH_MIN_SETPOINT" value="-40" unit="deg"/>

    <define name="PITCH_PGAIN" value="11000"/>
    <define name="PITCH_DGAIN" value="4."/>
    <define name="PITCH_IGAIN" value="60"/>
    <define name="PITCH_KFFA" value="10."/>
    <define name="PITCH_KFFD" value="0."/>

    <define name="PITCH_OF_ROLL" value="2." unit="deg"/>
    <define name="ELEVATOR_OF_ROLL" value="1200" unit="PPRZ_MAX"/>
    <define name="ROLL_SLEW" value="0.3"/>

    <define name="ROLL_ATTITUDE_GAIN" value="10000."/>
    <define name="ROLL_RATE_GAIN" value="800."/>
    <define name="ROLL_IGAIN" value="80."/>
    <define name="ROLL_KFFA" value="15"/>
    <define name="ROLL_KFFD" value="0."/>
  </section>

  <!--  We have value of Classic as well as ETECS, this since airframe is first flown "Classic" the ETECS, makes tunng a bit easier -->
  <section name="VERTICAL CONTROL" prefix="V_CTL_">
    <!-- power -->
    <define name="POWER_CTL_BAT_NOMINAL" value="14.4" unit="volt"/>

    <!-- Classic -->
    <!-- outer loop proportional gain -->
    <define name="ALTITUDE_PGAIN" value="0.12"/> <!--unit="(m/s)/m"-->
    <!-- disable climb rate limiter -->
    <define name="AUTO_CLIMB_LIMIT" value="1.6*V_CTL_ALTITUDE_MAX_CLIMB"/>
    <!-- auto throttle -->
    <!-- Cruise throttle + limits -->
    <define name="AUTO_THROTTLE_MIN_CRUISE_THROTTLE" value="0.38" unit="%"/>  
    <define name="AUTO_THROTTLE_NOMINAL_CRUISE_THROTTLE" value="0.46" unit="%"/> 
    <define name="AUTO_THROTTLE_MAX_CRUISE_THROTTLE" value="0.56" unit="%"/>

    <define name="AUTO_THROTTLE_LOITER_TRIM" value="1000" unit="pprz_t"/>
    <define name="AUTO_THROTTLE_DASH_TRIM" value="-2000" unit="pprz_t"/>

    <define name="AUTO_THROTTLE_CLIMB_THROTTLE_INCREMENT" value="0.08" unit="%/(m/s)"/> 

    <!-- Climb loop (throttle) -->
    <define name="AUTO_THROTTLE_PGAIN" value="0.04" unit="%/(m/s)"/>
    <define name="AUTO_THROTTLE_IGAIN" value="0.005"/>
    <define name="AUTO_THROTTLE_DGAIN" value="0.001"/>
    <define name="AUTO_THROTTLE_PITCH_OF_VZ_PGAIN" value="0.05" unit="rad/(m/s)"/> 
    <define name="AUTO_THROTTLE_NOMINAL_CRUISE_PITCH" value="0." unit="rad"/> <!-- default 0 -->

    <define name="THROTTLE_SLEW_LIMITER" value="0.7" unit="m/s/s"/>  <!-- Limiter for e.g. a powerful motor -->

    <!-- airspeed control -->
    <!-- Best to never set AUTO_AIRSPEED_SETPOINT lower than airframe stall speed if you hate repairs ;) -->
    <define name="AUTO_AIRSPEED_SETPOINT" value="15.0" unit="m/s"/>
    <define name="AUTO_AIRSPEED_THROTTLE_PGAIN" value="0.11" unit="%/(m/s)"/>
    <define name="AUTO_AIRSPEED_THROTTLE_DGAIN" value="0.11"/>
    <define name="AUTO_AIRSPEED_THROTTLE_IGAIN" value="0.008"/>
    <define name="AUTO_AIRSPEED_PITCH_PGAIN" value="0.07" unit="degree/(m/s)"/>
    <define name="AUTO_AIRSPEED_PITCH_DGAIN" value="0.001"/>
    <define name="AUTO_AIRSPEED_PITCH_IGAIN" value="0.05"/>

    <define name="AIRSPEED_MAX" value="34.0" unit="m/s"/>
    <define name="AIRSPEED_MIN" value="11.0" unit="m/s"/>

    <!-- pitch trim -->
    <define name="PITCH_LOITER_TRIM" value="0.5" unit="deg"/> <!-- Non ETECS -->
    <define name="PITCH_DASH_TRIM" value="0." unit="deg"/> <!-- Non ETECS -->

    <!-- groundspeed control -->
    <define name="AUTO_GROUNDSPEED_SETPOINT" value="12.0" unit="m/s"/>
    <define name="AUTO_GROUNDSPEED_PGAIN" value="0.8"/>
    <define name="AUTO_GROUNDSPEED_IGAIN" value="0.1"/>

    <define name="AIRSPEED_PGAIN" value="0.25"/>

    <!-- outer loop saturation -->
    <define name="ALTITUDE_MAX_CLIMB" value="7.0" unit="m/s"/>
    <define name="MAX_ACCELERATION" value="1.8" unit="G"/>

    <!-- Only for control classic as in not new or enegry etc.-->
    <define name="AUTO_AIRSPEED_PGAIN" value="0.14" unit="%/(m/s)"/>
    <define name="AUTO_AIRSPEED_IGAIN" value="0.2"/>

    
    <!-- Climb loop (pitch) -->
    <define name="AUTO_PITCH_PGAIN" value="0.020"/> 
    <define name="AUTO_PITCH_DGAIN" value="0.01"/>   
    <define name="AUTO_PITCH_IGAIN" value="0.003"/> 
    <!--define name="AUTO_PITCH_CLIMB_THROTTLE_INCREMENT" value="0.14"/-->
    <define name="AUTO_PITCH_MAX_PITCH" value="30" unit="deg"/>
    <define name="AUTO_PITCH_MIN_PITCH" value="-30" unit="deg"/>

    <!-- ============= ETECS ============= -->
    <define name="ENERGY_TOT_PGAIN" value="0.30"/> 
    <define name="ENERGY_TOT_IGAIN" value="0.25"/> 
    <define name="ENERGY_DIFF_PGAIN" value="0.40"/> 
    <define name="ENERGY_DIFF_IGAIN" value="0.15"/> 

    <define name="GLIDE_RATIO" value="8."/>

    <define name="AUTO_THROTTLE_OF_AIRSPEED_PGAIN" value="0.07"/>
    <define name="AUTO_THROTTLE_OF_AIRSPEED_IGAIN" value="0.01"/>

    <define name="AUTO_PITCH_OF_AIRSPEED_PGAIN" value="0.01"/> 
    <define name="AUTO_PITCH_OF_AIRSPEED_IGAIN" value="0.003"/> 
    <define name="AUTO_PITCH_OF_AIRSPEED_DGAIN" value="0.03"/> 
  </section>

  <section name="AGGRESSIVE" prefix="AGR_">
    <define name="BLEND_START" value="20" unit="m"/>
    <define name="BLEND_END" value="10" unit="m"/>
    <define name="CLIMB_THROTTLE" value="0.85" unit="%"/>
    <define name="CLIMB_PITCH" value="40" unit="deg"/>
    <define name="DESCENT_THROTTLE" value="0.5" unit="%"/>
    <define name="DESCENT_PITCH" value="-40" unit="deg"/>
    <define name="CLIMB_NAV_RATIO" value="0.8" unit="%"/>
    <define name="DESCENT_NAV_RATIO" value="0.95" unit="%"/>
  </section>

  <section name="BAT">
    <!-- tested at 14.8V common voltage -->  <!-- At idle RPM then 0.15A, 60% throttle 9A, Full 25A-->
    <define name="MilliAmpereOfAdc(adc)" value="(float)(adc) * 50.55"/><!-- Note that at low current the sensor used is not accurate -->
    <define name="VoltageOfAdc(adc)" value="((3.3f/4096.0f) * 12.198f * adc)"/><!-- Quite accurate -->

    <define name="MILLIAMP_AT_IDLE_THROTTLE" value="120" unit="mA"/>
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="25000" unit="mA"/>
    <define name="CURRENT_ESTIMATION_NONLINEARITY" value="1.01"/>
    <!--<define name="BAT_NB_CELLS" value="4"/> --><!-- If enable displayed in GCS, too confusing and not per cell reality so not enabled -->

    <!-- Modern 4S Li-Ion 4 x 4.2V = 16.8V -->
    <!-- <define name="MAX_BAT_CAPACITY" value="3300" unit="mAh"/> --><!-- Alternative Battery -->
    <define name="MAX_BAT_CAPACITY" value="11000" unit="mAh"/>
    <define name="MAX_BAT_LEVEL" value="16.8" unit="V"/> 
    <define name="LOW_BAT_LEVEL" value="14.4" unit="V"/>
    <define name="CRITIC_BAT_LEVEL" value="12.8" unit="V"/>
    <define name="CATASTROPHIC_BAT_LEVEL" value="10.8" unit="V"/>
  </section>

  <section name="MISC">
    <!-- All for use with default motor and propeller -->
    <define name="MINIMUM_AIRSPEED" value="11.0" unit="m/s"/>
    <define name="NOMINAL_AIRSPEED" value="15.0" unit="m/s"/>
    <define name="MAXIMUM_AIRSPEED" value="34.0" unit="m/s"/>
    <define name="CLIMB_AIRSPEED" value="13.0" unit="m/s"/>
    <define name="TRACKING_AIRSPEED" value="24.0" unit="m/s"/>
    <define name="GLIDE_AIRSPEED" value="12.0" unit="m/s"/>
    <define name="STALL_AIRSPEED" value="10.0" unit="m/s"/>
    <define name="RACE_AIRSPEED" value="28.0" unit="m/s"/>
    <define name="MIN_SPEED_FOR_TAKEOFF" value="13.0" unit="m/s"/>
    <define name="AIRSPEED_SETPOINT_SLEW" value="0.5" unit="m/s/s"/>

    <define name="TAKEOFF_PITCH_ANGLE" value="20" unit="deg"/>
    <define name="FLARE_PITCH_ANGLE" value="7" unit="deg"/>
    <define name="NAV_GLIDE_PITCH_TRIM" value="1.0" unit="deg"/>

    <define name="KILL_MODE_DISTANCE" value="MAX_DIST_FROM_HOME*1.3+HOME_RADIUS" unit="m"/>
    <define name="DEFAULT_CIRCLE_RADIUS" value="70.0" unit="m"/>
    <define name="HOME_RADIUS" value="DEFAULT_CIRCLE_RADIUS" unit="m"/>
    <define name="LANDING_CIRCLE_RADIUS" value="60.0" unit="m"/>
    <define name="MIN_CIRCLE_RADIUS" value="50.0" unit="m"/>

    <define name="CARROT" value="6.0" unit="s"/>

    <define name="UNLOCKED_HOME_MODE" value="TRUE"/>
    <define name="RC_LOST_MODE" value="AP_MODE_AUTO2"/>

    <define name="NO_XBEE_API_INIT" value="TRUE"/>
  </section>

  <section name="PHOTOGRAMMETRY" prefix="PHOTOGRAMMETRY_">
    <define name="FOCAL_LENGTH" value="2.5" unit="mm"/>
    <define name="SENSOR_WIDTH" value="2.304" unit="mm"/>
    <define name="SENSOR_HEIGHT" value="1.728" unit="mm"/>
    <define name="PIXELS_WIDTH" value="320"/>

    <!-- Photogrammetry Parameters. Can also be defined in a flightplan instead
    <define name="OVERLAP" value="0.3" unit="%"/>
    <define name="SIDELAP" value="0.2" unit="%"/>
    <define name="RESOLUTION" value="50" unit="mm pixel projection"/>
    -->
    <!-- note: only for PHOTOGRAMMETRY-->
    <define name="HEIGHT_MIN" value="20." unit="m"/>
    <define name="HEIGHT_MAX" value="120." unit="m"/>
    <define name="RADIUS_MIN" value="70." unit="m"/>
  </section>

  <section name="AIR_DATA" prefix="AIR_DATA_">
    <define name="CALC_AIRSPEED" value="TRUE"/>
    <define name="CALC_TAS_FACTOR" value="FALSE"/>
    <define name="CALC_AMSL_BARO" value="TRUE"/>
  </section>

  <section name="GLS_APPROACH" prefix="APP_">
    <define name="DISTANCE_AF_SD" value="30" unit="m"/>
    <define name="ANGLE" value="4" unit="deg"/>
    <define name="INTERCEPT_AF_SD" value="50" unit="m"/>
    <!--<define name="INTERCEPT_RATE" value="0.624" unit="m/s/s"/>-->
    <define name="TARGET_SPEED" value="GLIDE_AIRSPEED*1.1" unit="m/s"/>
  </section>

  <section name="GCS">
    <define name="SPEECH_NAME" value="Wing $(AC_ID)"/><!--or was it $AC_ID -->
    <define name="AC_ICON" value="flyingwing"/>
    <define name="ALT_SHIFT_PLUS_PLUS" value="50"/>
    <define name="ALT_SHIFT_PLUS" value="10"/>
    <define name="ALT_SHIFT_MINUS" value="-10"/>
  </section>

  <section name="TCAS" prefix="TCAS_">
    <define name="TAU_TA" value="6." unit="s"/>
    <define name="TAU_RA" value="4." unit="s"/>
    <define name="ALIM" value="12." unit="m"/>
    <define name="DMOD" value="14." unit="m"/>
    <define name="DT_MAX" value="1500" unit="ms"/>
  </section>

  <section name="SIMU">
    <define name="JSBSIM_LAUNCHSPEED" value="NOMINAL_AIRSPEED" unit="m/s"/>
    <define name="WEIGHT" value="1."/>
    <define name="JSBSIM_IR_ROLL_NEUTRAL" value="RadOfDeg(0.0)"/>
    <define name="JSBSIM_IR_PITCH_NEUTRAL" value="RadOfDeg(0.0)"/>
    <define name="YAW_RESPONSE_FACTOR" value="0.6"/>
    <define name="PITCH_RESPONSE_FACTOR" value="1.0"/>
    <define name="ROLL_RESPONSE_FACTOR" value="20.0"/>
  </section>

</airframe>
