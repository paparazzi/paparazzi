<!DOCTYPE module SYSTEM "module.dtd">

<module name="dfu_command" task="datalink"><!-- task="datalink" to run before telemetry_transparent_usb -->
  <doc>
    <description>
    THIS MODULE MUST BE PLACED ABOVE ANY USB SERIAL CONSUMERS IN THE AIRFRAME!
    
    Read USB serial for dfu command. Send 'dfu\n' to reboot to DFU mode.
    
    The dfu command is automatically sent when uploading with DFU or DFU-UTIL
    (see configure below). Override the command in the airframe file to disable
    or change the serial device.
    </description>
  </doc>
  <header>
    <file name="dfu_command.h"/>
  </header>
  <event fun="dfu_command_event()"/>
  <makefile target="!fbw|sim|nps|hitl">
    <configure name="DFU_PRE_UPLOAD_CMD" default="echo -e 'dfu\n' > /dev/ttyACM0 && sleep 1"/>
    <configure name="DFU_UTIL_PRE_UPLOAD_CMD" default="echo -e 'dfu\n' > /dev/ttyACM0 && sleep 1"/>
    <define name="USE_USB_SERIAL"/>
    <file name="dfu_command.c"/>
    <file_arch name="usb_ser_hw.c" dir="."/>
  </makefile>
</module>

